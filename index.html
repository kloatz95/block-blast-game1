<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Блок Взрыв! - Социальная Версия</title>
    
    <!-- VK Mini Apps Bridge -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    
    <!-- App Metadata -->
    <meta name="description" content="Захватывающая головоломка с блоками! Составляй линии, зарабатывай очки и соревнуйся с друзьями!">
    <meta name="keywords" content="игра, головоломка, блоки, ВКонтакте, mini app">
    <meta name="author" content="Block Blast Game">
    
    <!-- Open Graph for VK -->
    <meta property="og:title" content="Блок Взрыв! - Социальная Игра">
    <meta property="og:description" content="Захватывающая головоломка с блоками! Составляй линии, зарабатывай очки и соревнуйся с друзьями!">
    <meta property="og:type" content="game">
    <meta property="og:url" content="https://vk.com/app53745312">
    <meta property="og:image" content="https://your-domain.com/og-image.jpg">
    
    <!-- Disable zooming and selection for better mobile experience -->
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&display=swap');

        /* CSS Variables for easy theming */
        :root {
            --primary-bg: linear-gradient(135deg, #0f0c29 0%, #302b63 35%, #24243e 70%, #1a1a2e 100%);
            --card-bg: rgba(0, 0, 0, 0.4);
            --card-border: rgba(255, 255, 255, 0.1);
            --accent-color: #feca57;
            --accent-gradient: linear-gradient(45deg, #feca57, #ff9ff3);
            --text-primary: white;
            --text-secondary: #a8b2d1;
            --energy-color: #feca57;
            --coin-color: #ffd700;
            --success-color: #1dd1a1;
            --danger-color: #e74c3c;
            --grid-bg: rgba(0, 0, 0, 0.5);
            --grid-border: rgba(72, 219, 251, 0.4);
        }

        body {
            font-family: 'Exo 2', sans-serif;
            background: var(--primary-bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
            animation: backgroundPulse 8s ease-in-out infinite;
            /* Background image support */
            background-image: url('./assets/images/background.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        @keyframes backgroundPulse {
            0%, 100% { filter: brightness(1) hue-rotate(0deg); }
            50% { filter: brightness(1.1) hue-rotate(5deg); }
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 20px;
            background: var(--accent-gradient);
            background-size: 400% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: logoShimmer 2s ease-in-out infinite;
            /* Logo icon support */
            background-image: url('./assets/icons/logo.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 120px;
            height: 120px;
        }

        @keyframes logoShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            opacity: 0.8;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .game-container {
            max-width: 100%;
            width: 100%;
            height: 100vh;
            background: var(--primary-bg);
            border-radius: 0;
            backdrop-filter: none;
            border: none;
            overflow: hidden;
            box-shadow: none;
            position: relative;
            opacity: 0;
            transform: translateY(0);
            transition: all 0.5s ease;
            display: flex;
            flex-direction: column;
            /* Container background image support */
            background-image: url('./assets/images/game-bg.jpg');
            background-size: cover;
            background-position: center;
        }

        .game-container.loaded {
            opacity: 1;
            transform: translateY(0);
        }

        /* HEADER WITH STATS */
        .header {
            padding: 10px 15px;
            text-align: center;
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.25) 0%, rgba(79, 70, 229, 0.25) 100%);
            border-bottom: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
            /* Header background image support */
            background-image: url('./assets/images/header-bg.png');
            background-size: cover;
            background-position: center;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.03), transparent);
            animation: headerSweep 10s linear infinite;
            pointer-events: none;
        }

        @keyframes headerSweep {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* USER PROFILE - Redesigned */
        .user-profile-main {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            margin-bottom: 12px;
            position: relative;
            transition: all 0.3s ease;
            backdrop-filter: blur(15px);
            gap: 12px;
            /* Profile card background */
            background-image: url('./assets/images/profile-card-bg.png');
            background-size: cover;
            background-position: center;
        }

        .user-profile-main:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .user-avatar-main {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            animation: avatarPulse 3s ease-in-out infinite;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            /* Avatar border icon */
            background-image: url('./assets/icons/avatar-border.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .user-avatar-main img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        @keyframes avatarPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(102, 126, 234, 0.5); }
        }

        .user-info-main {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .user-name-main {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(254, 202, 87, 0.5);
            line-height: 1.2;
            margin-bottom: 2px;
        }

        .user-level-main {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .level-icon {
            width: 16px;
            height: 16px;
            background-image: url('./assets/icons/level.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* ENERGY & LEVEL SYSTEM */
        .top-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 8px;
        }

        .energy-container, .coins-container {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            flex: 1;
            position: relative;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            /* Energy and coins background */
            background-image: url('./assets/images/stat-card-bg.png');
            background-size: cover;
            background-position: center;
        }

        .energy-container:hover, .coins-container:hover {
            transform: translateY(-1px);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .energy-icon, .coins-icon {
            font-size: 16px;
            margin-right: 6px;
            animation: iconPulse 2s ease-in-out infinite;
            width: 20px;
            height: 20px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .energy-icon {
            background-image: url('./assets/icons/energy.png');
        }

        .coins-icon {
            background-image: url('./assets/icons/coin.png');
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .energy-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .energy-count, .coins-count {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(254, 202, 87, 0.5);
        }

        .energy-timer {
            font-size: 9px;
            color: var(--text-secondary);
            margin-top: 1px;
        }

        /* XP Progress */
        .xp-progress-container {
            margin-bottom: 10px;
        }

        .xp-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 2px;
            position: relative;
            /* XP bar background */
            background-image: url('./assets/images/xp-bar-bg.png');
            background-size: cover;
            background-position: center;
        }

        .xp-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: xpShimmer 2s linear infinite;
        }

        @keyframes xpShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .xp-fill {
            height: 100%;
            background: var(--accent-gradient);
            border-radius: 3px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            /* XP fill image */
            background-image: url('./assets/images/xp-fill.png');
            background-size: cover;
            background-position: center;
        }

        .xp-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: xpFillShine 1.5s ease-in-out infinite;
        }

        @keyframes xpFillShine {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .xp-text {
            font-size: 9px;
            color: var(--text-secondary);
            text-align: center;
        }

        /* SCORE CONTAINER */
        .score-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
            /* Score card background */
            background-image: url('./assets/images/score-card-bg.png');
            background-size: cover;
            background-position: center;
        }

        .score-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            animation: scoreGlow 4s linear infinite;
        }

        @keyframes scoreGlow {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .score-item {
            text-align: center;
            flex: 1;
            position: relative;
            z-index: 1;
        }

        .score-label {
            font-size: 9px;
            opacity: 0.8;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .score-value {
            font-size: 16px;
            font-weight: 900;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(254, 202, 87, 0.5);
            transition: all 0.3s ease;
        }

        .score-value.updated {
            animation: scoreBlast 0.8s ease-out;
        }

        @keyframes scoreBlast {
            0% { transform: scale(1); filter: brightness(1); }
            30% { transform: scale(1.3); filter: brightness(2) drop-shadow(0 0 10px #feca57); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        /* NAVIGATION TABS */
        .nav-tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: 8px;
            padding: 3px;
            margin: 0 0 15px 0;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 2;
            /* Tabs background */
            background-image: url('./assets/images/tabs-bg.png');
            background-size: cover;
            background-position: center;
        }

        .nav-tab {
            flex: 1;
            padding: 8px 6px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 11px;
            font-weight: 600;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transform: translateY(-1px);
            /* Active tab background */
            background-image: url('./assets/images/active-tab-bg.png');
            background-size: cover;
            background-position: center;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 2px;
            background: var(--accent-gradient);
            border-radius: 1px;
        }

        /* Tab icons */
        .tab-icon {
            width: 16px;
            height: 16px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            display: inline-block;
            vertical-align: middle;
            margin-right: 4px;
        }

        .tab-game { background-image: url('./assets/icons/tab-game.png'); }
        .tab-shop { background-image: url('./assets/icons/tab-shop.png'); }
        .tab-leaderboard { background-image: url('./assets/icons/tab-leaderboard.png'); }
        .tab-friends { background-image: url('./assets/icons/tab-friends.png'); }

        /* GAME CONTENT */
        .game-content {
            display: none;
            padding: 10px;
            flex: 1;
            overflow-y: auto;
        }

        .game-content.active {
            display: flex;
            flex-direction: column;
            animation: contentSlideIn 0.5s ease-out;
        }

        @keyframes contentSlideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-board {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            flex: 1;
            justify-content: center;
        }

        .grid-container {
            position: relative;
            background: var(--grid-bg);
            padding: 8px;
            border-radius: 10px;
            box-shadow: 
                inset 0 4px 20px rgba(0, 0, 0, 0.6),
                0 0 40px rgba(72, 219, 251, 0.2),
                0 0 0 1px var(--grid-border);
            border: 1px solid var(--grid-border);
            backdrop-filter: blur(20px);
            /* Grid container background */
            background-image: url('./assets/images/grid-container-bg.png');
            background-size: cover;
            background-position: center;
        }

        .grid-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #48dbfb, #1dd1a1, #feca57, #ff9ff3, #48dbfb);
            background-size: 400% 400%;
            border-radius: 12px;
            z-index: -1;
            opacity: 0;
            animation: gridPulse 6s ease-in-out infinite;
        }

        @keyframes gridPulse {
            0%, 100% { opacity: 0; background-position: 0% 50%; }
            50% { opacity: 0.5; background-position: 100% 50%; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 3px;
            width: 360px;
            height: 360px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 8px;
            position: relative;
            /* Grid background */
            background-image: url('./assets/images/grid-bg.png');
            background-size: cover;
            background-position: center;
        }

        .cell {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 4px;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            /* Empty cell background */
            background-image: url('./assets/images/empty-cell.png');
            background-size: cover;
            background-position: center;
        }

        .cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .cell:hover::before {
            opacity: 1;
        }

        .cell.filled {
            animation: blockExplode 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-origin: center;
        }

        .cell.filled::after {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.1) 50%, transparent 100%);
            border-radius: 3px;
            pointer-events: none;
        }

        /* Block color images */
        .cell.filled.color-red {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            background-image: url('./assets/images/block-red.png');
            background-size: cover;
            background-position: center;
            border-color: #ff5252;
            box-shadow: 
                0 0 20px rgba(255, 107, 107, 0.8),
                inset 0 2px 8px rgba(255, 255, 255, 0.3);
        }

        .cell.filled.color-blue {
            background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
            background-image: url('./assets/images/block-blue.png');
            background-size: cover;
            background-position: center;
            border-color: #0abde3;
            box-shadow: 
                0 0 20px rgba(72, 219, 251, 0.8),
                inset 0 2px 8px rgba(255, 255, 255, 0.3);
        }

        .cell.filled.color-green {
            background: linear-gradient(135deg, #1dd1a1 0%, #10ac84 100%);
            background-image: url('./assets/images/block-green.png');
            background-size: cover;
            background-position: center;
            border-color: #10ac84;
            box-shadow: 
                0 0 20px rgba(29, 209, 161, 0.8),
                inset 0 2px 8px rgba(255, 255, 255, 0.3);
        }

        .cell.filled.color-purple {
            background: linear-gradient(135deg, #a55eea 0%, #8854d0 100%);
            background-image: url('./assets/images/block-purple.png');
            background-size: cover;
            background-position: center;
            border-color: #8854d0;
            box-shadow: 
                0 0 20px rgba(165, 94, 234, 0.8),
                inset 0 2px 8px rgba(255, 255, 255, 0.3);
        }

        .cell.filled.color-orange {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
            background-image: url('./assets/images/block-orange.png');
            background-size: cover;
            background-position: center;
            border-color: #ff9ff3;
            box-shadow: 
                0 0 20px rgba(254, 202, 87, 0.8),
                inset 0 2px 8px rgba(255, 255, 255, 0.3);
        }

        .cell.preview {
            background: rgba(255, 255, 255, 0.4);
            background-image: url('./assets/images/preview-cell.png');
            background-size: cover;
            background-position: center;
            border-color: rgba(255, 255, 255, 0.8);
            animation: previewDance 0.6s ease-in-out infinite;
            box-shadow: 
                0 0 25px rgba(255, 255, 255, 0.6),
                inset 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .cell.clearing {
            animation: clearNova 0.8s ease-out forwards;
            z-index: 10;
        }

        @keyframes blockExplode {
            0% { 
                transform: scale(0) rotate(180deg); 
                opacity: 0;
                filter: brightness(2);
            }
            70% { 
                transform: scale(1.2) rotate(10deg); 
                opacity: 1;
                filter: brightness(1.5);
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1;
                filter: brightness(1);
            }
        }

        @keyframes previewDance {
            0%, 100% { 
                opacity: 0.5; 
                transform: scale(1) rotate(0deg); 
            }
            50% { 
                opacity: 0.9; 
                transform: scale(1.1) rotate(2deg); 
            }
        }

        @keyframes clearNova {
            0% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1;
                filter: brightness(1);
            }
            50% { 
                transform: scale(1.5) rotate(180deg); 
                opacity: 0.8;
                filter: brightness(3) hue-rotate(90deg);
            }
            100% { 
                transform: scale(0) rotate(360deg); 
                opacity: 0;
                filter: brightness(5) hue-rotate(180deg);
            }
        }

        /* BOOSTERS PANEL */
        .boosters-panel {
            display: flex;
            justify-content: space-around;
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
            backdrop-filter: blur(15px);
            position: relative;
            overflow: hidden;
            /* Boosters panel background */
            background-image: url('./assets/images/boosters-panel-bg.png');
            background-size: cover;
            background-position: center;
        }

        .boosters-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            animation: boosterSweep 5s linear infinite;
        }

        @keyframes boosterSweep {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .booster-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 8px;
            border-radius: 8px;
            position: relative;
            z-index: 1;
            background: transparent;
            /* Booster card background */
            background-image: url('./assets/images/booster-card-bg.png');
            background-size: cover;
            background-position: center;
        }

        .booster-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 8px;
            opacity: 0;
            transition: all 0.3s ease;
            transform: scale(0.8);
        }

        .booster-item:hover::before {
            opacity: 1;
            transform: scale(1);
        }

        .booster-item:hover {
            transform: translateY(-3px) scale(1.05);
        }

        .booster-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(0.8);
        }

        .booster-item.disabled:hover {
            transform: none;
        }

        .booster-icon {
            font-size: 22px;
            margin-bottom: 4px;
            filter: drop-shadow(0 3px 8px rgba(0, 0, 0, 0.6));
            animation: boosterFloat 3s ease-in-out infinite;
            width: 28px;
            height: 28px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* Booster icon images */
        .booster-shape-choice { background-image: url('./assets/icons/booster-shape-choice.png'); }
        .booster-row-blast { background-image: url('./assets/icons/booster-row-blast.png'); }
        .booster-refresh { background-image: url('./assets/icons/booster-refresh.png'); }
        .booster-lightning { background-image: url('./assets/icons/booster-lightning.png'); }
        .booster-star-blast { background-image: url('./assets/icons/booster-star-blast.png'); }

        @keyframes boosterFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }

        .booster-count {
            font-size: 11px;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 18px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
            border: 1px solid rgba(255, 215, 0, 0.6);
            /* Count badge background */
            background-image: url('./assets/images/count-badge-bg.png');
            background-size: cover;
            background-position: center;
        }

        /* SHAPES AREA */
        .shapes-area {
            width: 100%;
            height: 140px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            position: relative;
            border: 1px solid var(--card-border);
            backdrop-filter: blur(15px);
            overflow: hidden;
            /* Shapes area background */
            background-image: url('./assets/images/shapes-area-bg.png');
            background-size: cover;
            background-position: center;
        }

        .shapes-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.02), transparent);
            animation: shapesShimmer 4s linear infinite;
        }

        @keyframes shapesShimmer {
            0% { transform: translateX(-100%) translateY(-100%); }
            100% { transform: translateX(100%) translateY(100%); }
        }

        .shape-slot {
            width: 90px;
            height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.03) 100%);
            border-radius: 10px;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            position: relative;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            /* Shape slot background */
            background-image: url('./assets/images/shape-slot-bg.png');
            background-size: cover;
            background-position: center;
        }

        .shape-slot::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .shape-slot:hover::before {
            opacity: 1;
        }

        .shape-slot.active {
            border-color: var(--accent-color);
            background: radial-gradient(circle, rgba(254, 202, 87, 0.2) 0%, rgba(254, 202, 87, 0.05) 100%);
            box-shadow: 0 0 30px rgba(254, 202, 87, 0.5);
            transform: scale(1.05);
        }

        .shape {
            display: grid;
            gap: 1.5px;
            cursor: grab;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 100;
            padding: 5px;
        }

        .shape:active {
            cursor: grabbing;
        }

        .shape:hover {
            transform: scale(1.08) rotate(2deg);
            filter: brightness(1.2) drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5));
        }

        .shape.dragging {
            opacity: 0.8;
            transform: scale(0.95);
            pointer-events: none;
        }

        .shape.used {
            opacity: 0;
            transform: scale(0) rotate(270deg);
            pointer-events: none;
            transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .shape-block {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            box-shadow: 
                0 3px 10px rgba(0, 0, 0, 0.4),
                inset 0 1px 3px rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            transition: all 0.3s ease;
        }

        .shape-block::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            right: 1px;
            bottom: 1px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4) 0%, transparent 100%);
            border-radius: 3px;
        }

        .shape-block.empty {
            background: transparent;
            box-shadow: none;
            border: none;
        }

        .shape-block.empty::before {
            display: none;
        }

        /* Shape colors with images */
        .shape[data-color="red"] .shape-block:not(.empty) {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            background-image: url('./assets/images/shape-block-red.png');
            background-size: cover;
            background-position: center;
            box-shadow: 
                0 3px 10px rgba(255, 107, 107, 0.6),
                inset 0 1px 3px rgba(255, 255, 255, 0.4);
        }

        .shape[data-color="blue"] .shape-block:not(.empty) {
            background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
            background-image: url('./assets/images/shape-block-blue.png');
            background-size: cover;
            background-position: center;
            box-shadow: 
                0 3px 10px rgba(72, 219, 251, 0.6),
                inset 0 1px 3px rgba(255, 255, 255, 0.4);
        }

        .shape[data-color="green"] .shape-block:not(.empty) {
            background: linear-gradient(135deg, #1dd1a1 0%, #10ac84 100%);
            background-image: url('./assets/images/shape-block-green.png');
            background-size: cover;
            background-position: center;
            box-shadow: 
                0 3px 10px rgba(29, 209, 161, 0.6),
                inset 0 1px 3px rgba(255, 255, 255, 0.4);
        }

        .shape[data-color="purple"] .shape-block:not(.empty) {
            background: linear-gradient(135deg, #a55eea 0%, #8854d0 100%);
            background-image: url('./assets/images/shape-block-purple.png');
            background-size: cover;
            background-position: center;
            box-shadow: 
                0 3px 10px rgba(165, 94, 234, 0.6),
                inset 0 1px 3px rgba(255, 255, 255, 0.4);
        }

        .shape[data-color="orange"] .shape-block:not(.empty) {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
            background-image: url('./assets/images/shape-block-orange.png');
            background-size: cover;
            background-position: center;
            box-shadow: 
                0 3px 10px rgba(254, 202, 87, 0.6),
                inset 0 1px 3px rgba(255, 255, 255, 0.4);
        }

        .floating-shape {
            position: fixed;
            pointer-events: none;
            z-index: 2000;
            transform: scale(1.2);
            opacity: 0.95;
            filter: drop-shadow(0 10px 25px rgba(0, 0, 0, 0.6)) brightness(1.2);
        }

        .floating-shape .shape-block {
            width: 24px;
            height: 24px;
            box-shadow: 
                0 5px 15px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(255, 255, 255, 0.3),
                inset 0 2px 5px rgba(255, 255, 255, 0.5);
        }

        /* SHOP CONTENT */
        .shop-content {
            padding: 16px;
        }

        .shop-section {
            margin-bottom: 20px;
        }

        .shop-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .shop-item {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--card-border);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            /* Shop item background */
            background-image: url('./assets/images/shop-item-bg.png');
            background-size: cover;
            background-position: center;
        }

        .shop-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(254, 202, 87, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .shop-item:hover::before {
            left: 100%;
        }

        .shop-item:hover {
            border-color: var(--accent-color);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(254, 202, 87, 0.3);
        }

        .shop-item-icon {
            font-size: 28px;
            margin-bottom: 8px;
            filter: drop-shadow(0 3px 8px rgba(0, 0, 0, 0.5));
            width: 32px;
            height: 32px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin: 0 auto 8px;
        }

        /* Shop item icons */
        .shop-icon-starter { background-image: url('./assets/icons/shop-starter.png'); }
        .shop-icon-premium { background-image: url('./assets/icons/shop-premium.png'); }
        .shop-icon-ultimate { background-image: url('./assets/icons/shop-ultimate.png'); }
        .shop-icon-energy { background-image: url('./assets/icons/shop-energy.png'); }
        .shop-icon-energy-full { background-image: url('./assets/icons/shop-energy-full.png'); }
        .shop-icon-coins { background-image: url('./assets/icons/shop-coins.png'); }

        .shop-item-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .shop-item-description {
            font-size: 10px;
            opacity: 0.7;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .shop-item-price {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 11px;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4);
            /* Price badge background */
            background-image: url('./assets/images/price-badge-bg.png');
            background-size: cover;
            background-position: center;
        }

        .shop-item-contents {
            display: flex;
            justify-content: space-around;
            margin: 8px 0;
            font-size: 10px;
        }

        .shop-item-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* VK Payment styles */
        .shop-item.vk-payment {
            border: 2px solid #4680c2;
            background: linear-gradient(135deg, rgba(70, 128, 194, 0.1), rgba(70, 128, 194, 0.05));
            background-image: url('./assets/images/vk-payment-bg.png');
            background-size: cover;
            background-position: center;
            position: relative;
            overflow: hidden;
        }

        .shop-item.vk-payment::before {
            background: linear-gradient(90deg, transparent, rgba(70, 128, 194, 0.2), transparent);
        }

        .shop-item.vk-payment:hover {
            border-color: #4680c2;
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(70, 128, 194, 0.4);
        }

        .vk-price {
            background: linear-gradient(135deg, #4680c2, #5181b8);
            background-image: url('./assets/images/vk-price-bg.png');
            background-size: cover;
            background-position: center;
            color: white;
        }

        .shop-item-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            background-image: url('./assets/images/badge-bg.png');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 8px;
            font-weight: 900;
            transform: rotate(15deg);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
            animation: badgePulse 2s ease-in-out infinite;
        }

        .premium-badge {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            background-image: url('./assets/images/premium-badge-bg.png');
            background-size: cover;
            background-position: center;
            color: #000;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
        }

        @keyframes badgePulse {
            0%, 100% { transform: rotate(15deg) scale(1); }
            50% { transform: rotate(15deg) scale(1.1); }
        }

        .shop-item.premium {
            border: 2px solid #ffd700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05));
            background-image: url('./assets/images/premium-item-bg.png');
            background-size: cover;
            background-position: center;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .shop-item.premium:hover {
            border-color: #ffd700;
            box-shadow: 0 15px 30px rgba(255, 215, 0, 0.5);
        }

        .bonus-item {
            font-size: 9px;
            color: #ffd700;
            margin: 2px 0;
            text-align: center;
        }

        /* Payment success animation */
        .payment-success {
            animation: paymentSuccess 1s ease-out;
        }

        @keyframes paymentSuccess {
            0% { 
                transform: scale(1);
                filter: brightness(1);
            }
            50% { 
                transform: scale(1.1);
                filter: brightness(1.5) hue-rotate(120deg);
                box-shadow: 0 0 30px rgba(29, 209, 161, 0.8);
            }
            100% { 
                transform: scale(1);
                filter: brightness(1);
            }
        }

        /* LEADERBOARD CONTENT */
        .leaderboard-tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: 8px;
            padding: 3px;
            margin-bottom: 16px;
            backdrop-filter: blur(10px);
            /* Leaderboard tabs background */
            background-image: url('./assets/images/leaderboard-tabs-bg.png');
            background-size: cover;
            background-position: center;
        }

        .leaderboard-tab {
            flex: 1;
            padding: 6px 8px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 10px;
            font-weight: 600;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
        }

        .leaderboard-tab.active {
            background: linear-gradient(135deg, #a55eea, #8854d0);
            background-image: url('./assets/images/active-leaderboard-tab-bg.png');
            background-size: cover;
            background-position: center;
            color: white;
            box-shadow: 0 3px 10px rgba(165, 94, 234, 0.4);
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            /* Leaderboard item background */
            background-image: url('./assets/images/leaderboard-item-bg.png');
            background-size: cover;
            background-position: center;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .leaderboard-item.me {
            border-color: var(--accent-color);
            background: rgba(254, 202, 87, 0.1);
            background-image: url('./assets/images/my-leaderboard-item-bg.png');
            background-size: cover;
            background-position: center;
            box-shadow: 0 0 20px rgba(254, 202, 87, 0.3);
        }

        .leaderboard-rank {
            font-size: 14px;
            font-weight: 700;
            margin-right: 12px;
            min-width: 25px;
            text-align: center;
        }

        .leaderboard-rank.gold { 
            color: #ffd700; 
            text-shadow: 0 0 10px #ffd700;
        }
        .leaderboard-rank.silver { 
            color: #c0c0c0; 
            text-shadow: 0 0 10px #c0c0c0;
        }
        .leaderboard-rank.bronze { 
            color: #cd7f32; 
            text-shadow: 0 0 10px #cd7f32;
        }

        .leaderboard-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            background-image: url('./assets/images/default-avatar.png');
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 16px;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
            object-fit: cover;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .leaderboard-level {
            font-size: 10px;
            opacity: 0.7;
        }

        .leaderboard-score {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-color);
            text-shadow: 0 0 8px rgba(254, 202, 87, 0.5);
        }

        /* REFERRAL CONTENT */
        .referral-content {
            padding: 16px;
        }

        .referral-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .referral-stat {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            /* Referral stat background */
            background-image: url('./assets/images/referral-stat-bg.png');
            background-size: cover;
            background-position: center;
        }

        .referral-stat:hover {
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .referral-stat-number {
            font-size: 20px;
            font-weight: 900;
            color: var(--accent-color);
            margin-bottom: 4px;
            text-shadow: 0 0 10px rgba(254, 202, 87, 0.5);
        }

        .referral-stat-label {
            font-size: 11px;
            opacity: 0.7;
        }

        .referral-rewards {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
            /* Referral rewards background */
            background-image: url('./assets/images/referral-rewards-bg.png');
            background-size: cover;
            background-position: center;
        }

        .referral-rewards-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .reward-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .reward-item:last-child {
            border-bottom: none;
        }

        .reward-icon {
            font-size: 18px;
            margin-right: 10px;
            width: 25px;
            text-align: center;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .reward-text {
            flex: 1;
            font-size: 12px;
        }

        .reward-amount {
            font-weight: 700;
            color: var(--accent-color);
        }

        .invite-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            background-image: url('./assets/images/invite-button-bg.png');
            background-size: cover;
            background-position: center;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .invite-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .progress-milestones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 8px;
        }

        .milestone {
            background: var(--card-bg);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            /* Milestone background */
            background-image: url('./assets/images/milestone-bg.png');
            background-size: cover;
            background-position: center;
        }

        .milestone.completed {
            border-color: var(--success-color);
            background: rgba(29, 209, 161, 0.1);
            background-image: url('./assets/images/milestone-completed-bg.png');
            background-size: cover;
            background-position: center;
            box-shadow: 0 0 15px rgba(29, 209, 161, 0.3);
        }

        .milestone.current {
            border-color: var(--accent-color);
            background: rgba(254, 202, 87, 0.1);
            background-image: url('./assets/images/milestone-current-bg.png');
            background-size: cover;
            background-position: center;
            box-shadow: 0 0 15px rgba(254, 202, 87, 0.3);
            animation: milestonePulse 2s ease-in-out infinite;
        }

        @keyframes milestonePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .milestone-number {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .milestone-reward {
            font-size: 18px;
            margin-bottom: 4px;
            width: 24px;
            height: 24px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin: 0 auto 4px;
        }

        .milestone-description {
            font-size: 9px;
            opacity: 0.7;
        }

        /* CONTROLS */
        .controls {
            display: flex;
            justify-content: space-between;
            padding: 16px;
            gap: 12px;
            background: rgba(0, 0, 0, 0.2);
            background-image: url('./assets/images/controls-bg.png');
            background-size: cover;
            background-position: center;
            border-top: 1px solid var(--card-border);
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #667eea, #764ba2);
            background-image: url('./assets/images/button-bg.png');
            background-size: cover;
            background-position: center;
            color: white;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-family: 'Exo 2', sans-serif;
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            background-image: url('./assets/images/button-secondary-bg.png');
            background-size: cover;
            background-position: center;
            flex: 0 0 auto;
            padding: 12px 15px;
        }

        /* Button icons */
        .btn-icon {
            width: 16px;
            height: 16px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-right: 4px;
        }

        .btn-pause { background-image: url('./assets/icons/pause.png'); }
        .btn-share { background-image: url('./assets/icons/share.png'); }
        .btn-restart { background-image: url('./assets/icons/restart.png'); }

        /* OVERLAYS */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            background-image: url('./assets/images/overlay-bg.png');
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
            z-index: 3000;
            backdrop-filter: blur(15px);
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .overlay-content {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            background-image: url('./assets/images/overlay-content-bg.png');
            background-size: cover;
            background-position: center;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 320px;
            width: 90%;
            border: 2px solid var(--card-border);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7);
            transform: scale(0.8);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            overflow: hidden;
        }

        .overlay.active .overlay-content {
            transform: scale(1);
        }

        .overlay-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            animation: overlayShine 3s linear infinite;
        }

        @keyframes overlayShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .overlay-content h2 {
            font-size: 24px;
            margin-bottom: 16px;
            font-weight: 900;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        .combo-display {
            position: absolute;
            top: 55px;
            right: 12px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            background-image: url('./assets/images/combo-bg.png');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 8px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 900;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .combo-display.active {
            opacity: 1;
            transform: scale(1);
            animation: comboRave 2s ease-in-out infinite;
        }

        @keyframes comboRave {
            0%, 100% { 
                box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
                filter: brightness(1);
            }
            50% { 
                box-shadow: 0 8px 35px rgba(255, 107, 107, 0.8);
                filter: brightness(1.3);
            }
        }

        .achievements {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 16px 0;
        }

        .achievement {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            background-image: url('./assets/images/achievement-bg.png');
            background-size: cover;
            background-position: center;
            color: #2c3e50;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 800;
            animation: achievementBurst 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            transform: scale(0);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            border: 1px solid rgba(255, 215, 0, 0.6);
        }

        @keyframes achievementBurst {
            0% { 
                transform: scale(0) rotate(-270deg); 
                filter: brightness(1);
            }
            70% { 
                transform: scale(1.2) rotate(10deg); 
                filter: brightness(1.5);
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                filter: brightness(1);
            }
        }

        .particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1500;
            overflow: hidden;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--success-color), #10ac84);
            background-image: url('./assets/images/notification-bg.png');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 12px;
            box-shadow: 0 10px 25px rgba(29, 209, 161, 0.4);
            transform: translateX(100%);
            transition: transform 0.4s ease;
            z-index: 4000;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification.show {
            transform: translateX(0);
            animation: notificationPulse 0.5s ease-out;
        }

        @keyframes notificationPulse {
            0% { transform: translateX(0) scale(0.9); }
            50% { transform: translateX(0) scale(1.05); }
            100% { transform: translateX(0) scale(1); }
        }

        /* ENERGY DEPLETED OVERLAY */
        .energy-depleted {
            background: rgba(0, 0, 0, 0.9);
        }

        .energy-depleted .overlay-content {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            background-image: url('./assets/images/energy-depleted-bg.png');
            background-size: cover;
            background-position: center;
        }

        /* LEVEL UP OVERLAY */
        .level-up {
            background: rgba(0, 0, 0, 0.8);
        }

        .level-up .overlay-content {
            background: linear-gradient(135deg, #a55eea, #8854d0);
            background-image: url('./assets/images/level-up-bg.png');
            background-size: cover;
            background-position: center;
        }

        /* NO ENERGY STATE */
        .no-energy .game-board {
            opacity: 0.3;
            pointer-events: none;
            filter: blur(3px) grayscale(0.5);
        }

        /* ADDITIONAL MEGA EFFECTS */
        .level-up-animation {
            animation: levelMegaPulse 1.5s ease-out;
        }

        @keyframes levelMegaPulse {
            0% { 
                transform: scale(1); 
                filter: brightness(1);
            }
            25% { 
                transform: scale(1.15); 
                filter: brightness(2) hue-rotate(90deg);
            }
            50% { 
                transform: scale(1.05); 
                filter: brightness(1.5) hue-rotate(180deg);
            }
            75% { 
                transform: scale(1.1); 
                filter: brightness(1.8) hue-rotate(270deg);
            }
            100% { 
                transform: scale(1); 
                filter: brightness(1) hue-rotate(360deg);
            }
        }

        .coin-gain-animation {
            animation: coinStorm 0.8s ease-out;
        }

        @keyframes coinStorm {
            0% { 
                transform: scale(1); 
                color: #ffd700;
            }
            25% { 
                transform: scale(1.3) rotate(5deg); 
                color: #ffd700;
                text-shadow: 0 0 20px #ffd700;
            }
            50% { 
                transform: scale(1.5) rotate(-5deg); 
                color: #ffed4e;
                text-shadow: 0 0 30px #ffed4e;
            }
            75% { 
                transform: scale(1.2) rotate(2deg); 
                color: #ffd700;
                text-shadow: 0 0 15px #ffd700;
            }
            100% { 
                transform: scale(1); 
                color: #ffd700;
            }
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 480px) {
            .game-container {
                max-width: 100%;
                border-radius: 0;
            }

            .grid {
                width: 340px;
                height: 340px;
            }

            .top-stats {
                flex-direction: row;
                gap: 6px;
            }

            .energy-container,
            .coins-container {
                flex: 1;
            }

            .nav-tabs {
                margin: 8px 0;
            }

            .nav-tab {
                font-size: 10px;
                padding: 6px 4px;
            }

            .shape-slot {
                width: 80px;
                height: 80px;
            }

            .shape-block {
                width: 18px;
                height: 18px;
            }

            .floating-shape .shape-block {
                width: 22px;
                height: 22px;
            }

            .shop-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-height: 700px) {
            .game-content {
                padding: 8px;
            }

            .game-board {
                gap: 12px;
            }

            .shapes-area {
                height: 120px;
                padding: 10px;
            }

            .shape-slot {
                width: 75px;
                height: 75px;
            }

            .grid {
                width: 320px;
                height: 320px;
            }
        }

        /* VK specific optimizations */
        .vk-ready {
            position: relative;
        }

        .vk-loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Russian language optimizations */
        body {
            font-feature-settings: "kern" 1, "liga" 1, "calt" 1;
            text-rendering: optimizeLegibility;
        }

        /* Image loading fallbacks */
        .loading-logo:not([style*="background-image"]) {
            text-indent: 0;
            font-size: 36px;
        }

        .booster-icon:not([class*="booster-"]) {
            text-indent: 0;
            font-size: 22px;
        }

        .shop-item-icon:not([class*="shop-icon-"]) {
            text-indent: 0;
            font-size: 28px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">⚡ БЛОК ВЗРЫВ! ⚡</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Подключение к ВКонтакте...</div>
    </div>

    <div class="game-container" id="gameContainer">
        
        <!-- HEADER WITH STATS -->
        <div class="header">
            <!-- User Profile Main -->
            <div class="user-profile-main">
                <div class="user-avatar-main" id="userAvatarMain">👤</div>
                <div class="user-info-main">
                    <div class="user-name-main" id="userNameMain">Игрок</div>
                    <div class="user-level-main">
                        <div class="level-icon"></div>
                        Уровень <span id="userLevelMain">1</span>
                    </div>
                </div>
            </div>
            
            <!-- User Info and Stats -->
            <div class="top-stats">
                <div class="energy-container">
                    <div class="energy-icon"></div>
                    <div class="energy-info">
                        <div class="energy-count" id="energyCount">5/5</div>
                        <div class="energy-timer" id="energyTimer"></div>
                    </div>
                </div>
                
                <div class="coins-container">
                    <div class="coins-icon"></div>
                    <div class="coins-count" id="coinsCount">100</div>
                </div>
            </div>

            <!-- XP Progress -->
            <div class="xp-progress-container">
                <div class="xp-bar">
                    <div class="xp-fill" id="xpFill" style="width: 0%"></div>
                </div>
                <div class="xp-text" id="xpText">0 / 100 XP</div>
            </div>

            <div class="combo-display" id="comboDisplay">
                🔥 КОМБО ×<span id="comboValue">1</span>
            </div>

            <!-- NAVIGATION TABS -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('game')">
                    <div class="tab-icon tab-game"></div>
                    Игра
                </button>
                <button class="nav-tab" onclick="showTab('shop')">
                    <div class="tab-icon tab-shop"></div>
                    Магазин
                </button>
                <button class="nav-tab" onclick="showTab('leaderboard')">
                    <div class="tab-icon tab-leaderboard"></div>
                    Рейтинг
                </button>
                <button class="nav-tab" onclick="showTab('referral')">
                    <div class="tab-icon tab-friends"></div>
                    Друзья
                </button>
            </div>
        </div>

        <!-- GAME CONTENT -->
        <div class="game-content active" id="gameContent">
            <!-- Score container -->
            <div class="score-container">
                <div class="score-item">
                    <div class="score-label">Очки</div>
                    <div class="score-value" id="score">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Рекорд</div>
                    <div class="score-value" id="bestScore">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Линии</div>
                    <div class="score-value" id="linesCleared">0</div>
                </div>
            </div>

            <!-- Boosters panel -->
            <div class="boosters-panel">
                <div class="booster-item" onclick="useBooster('shape_choice')" id="booster_shape_choice">
                    <div class="booster-icon booster-shape-choice">🎯</div>
                    <div class="booster-count" id="count_shape_choice">0</div>
                </div>
                <div class="booster-item" onclick="useBooster('row_blast')" id="booster_row_blast">
                    <div class="booster-icon booster-row-blast">💣</div>
                    <div class="booster-count" id="count_row_blast">0</div>
                </div>
                <div class="booster-item" onclick="useBooster('refresh')" id="booster_refresh">
                    <div class="booster-icon booster-refresh">🔄</div>
                    <div class="booster-count" id="count_refresh">2</div>
                </div>
                <div class="booster-item" onclick="useBooster('lightning')" id="booster_lightning">
                    <div class="booster-icon booster-lightning">⚡</div>
                    <div class="booster-count" id="count_lightning">0</div>
                </div>
                <div class="booster-item" onclick="useBooster('star_blast')" id="booster_star_blast">
                    <div class="booster-icon booster-star-blast">🌟</div>
                    <div class="booster-count" id="count_star_blast">0</div>
                </div>
            </div>

            <div class="game-board">
                <div class="grid-container">
                    <div class="grid" id="gameGrid"></div>
                    <div class="particles-container" id="particlesContainer"></div>
                </div>

                <div class="shapes-area" id="shapesArea">
                    <div class="shape-slot" id="slot0"></div>
                    <div class="shape-slot" id="slot1"></div>
                    <div class="shape-slot" id="slot2"></div>
                </div>
            </div>
        </div>

        <!-- SHOP CONTENT -->
        <div class="game-content" id="shopContent">
            <div class="shop-content">
                <div class="shop-section">
                    <div class="shop-title">🎁 Наборы Усилителей</div>
                    <div class="shop-grid">
                        <div class="shop-item" onclick="buyPack('starter')">
                            <div class="shop-item-icon shop-icon-starter">📦</div>
                            <div class="shop-item-name">Стартовый Набор</div>
                            <div class="shop-item-description">Отлично для новичков</div>
                            <div class="shop-item-contents">
                                <div class="shop-item-content">
                                    <div>🎯</div>
                                    <div>×3</div>
                                </div>
                                <div class="shop-item-content">
                                    <div>🔄</div>
                                    <div>×2</div>
                                </div>
                                <div class="shop-item-content">
                                    <div>💣</div>
                                    <div>×1</div>
                                </div>
                            </div>
                            <div class="shop-item-price">
                                <span>🪙 150</span>
                            </div>
                        </div>

                        <div class="shop-item" onclick="buyPack('premium')">
                            <div class="shop-item-icon shop-icon-premium">🎁</div>
                            <div class="shop-item-name">Премиум Набор</div>
                            <div class="shop-item-description">Выгодно для профи</div>
                            <div class="shop-item-contents">
                                <div class="shop-item-content">
                                    <div>🎯</div>
                                    <div>×5</div>
                                </div>
                                <div class="shop-item-content">
                                    <div>💣</div>
                                    <div>×3</div>
                                </div>
                                <div class="shop-item-content">
                                    <div>⚡</div>
                                    <div>×2</div>
                                </div>
                                <div class="shop-item-content">
                                    <div>🌟</div>
                                    <div>×1</div>
                                </div>
                            </div>
                            <div class="shop-item-price">
                                <span>🪙 450</span>
                            </div>
                        </div>

                        <div class="shop-item" onclick="buyPack('ultimate')">
                            <div class="shop-item-icon shop-icon-ultimate">💎</div>
                            <div class="shop-item-name">Ультимативный Набор</div>
                            <div class="shop-item-description">Максимальная мощь!</div>
                            <div class="shop-item-contents">
                                <div class="shop-item-content">
                                    <div>🎯</div>
                                    <div>×10</div>
                                </div>
                                <div class="shop-item-content">
                                    <div>💣</div>
                                    <div>×8</div>
                                </div>
                                <div class="shop-item-content">
                                    <div>⚡</div>
                                    <div>×5</div>
                                </div>
                                <div class="shop-item-content">
                                    <div>🌟</div>
                                    <div>×3</div>
                                </div>
                            </div>
                            <div class="shop-item-price">
                                <span>🪙 990</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="shop-section">
                    <div class="shop-title">⚡ Энергия</div>
                    <div class="shop-grid">
                        <div class="shop-item" onclick="buyEnergy(1)">
                            <div class="shop-item-icon shop-icon-energy">⚡</div>
                            <div class="shop-item-name">+1 Энергия</div>
                            <div class="shop-item-description">Мгновенное восполнение</div>
                            <div class="shop-item-price">
                                <span>🪙 50</span>
                            </div>
                        </div>

                        <div class="shop-item" onclick="buyEnergy(5)">
                            <div class="shop-item-icon shop-icon-energy-full">🔋</div>
                            <div class="shop-item-name">Полная Энергия</div>
                            <div class="shop-item-description">Полное восстановление</div>
                            <div class="shop-item-price">
                                <span>🪙 200</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="shop-section">
                    <div class="shop-title">💎 Монеты за голоса VK</div>
                    <div class="shop-grid">
                        <div class="shop-item vk-payment" onclick="buyCoinsVK(100, 1)">
                            <div class="shop-item-icon shop-icon-coins">🪙</div>
                            <div class="shop-item-name">100 Монет</div>
                            <div class="shop-item-description">Стартовый набор</div>
                            <div class="shop-item-price vk-price">
                                <span>💙 1 голос</span>
                            </div>
                        </div>

                        <div class="shop-item vk-payment" onclick="buyCoinsVK(500, 1)">
                            <div class="shop-item-icon shop-icon-coins">💰</div>
                            <div class="shop-item-name">500 Монет</div>
                            <div class="shop-item-description">Популярный выбор</div>
                            <div class="shop-item-price vk-price">
                                <span>💙 1 голос</span>
                            </div>
                            <div class="shop-item-badge">🔥 ХИТ</div>
                        </div>

                        <div class="shop-item vk-payment" onclick="buyCoinsVK(1000, 1)">
                            <div class="shop-item-icon shop-icon-coins">💎</div>
                            <div class="shop-item-name">1000 Монет</div>
                            <div class="shop-item-description">Выгодное предложение</div>
                            <div class="shop-item-price vk-price">
                                <span>💙 1 голос</span>
                            </div>
                            <div class="shop-item-badge">💰 ВЫГОДНО</div>
                        </div>

                        <div class="shop-item vk-payment premium" onclick="buyCoinsVK(2500, 1)">
                            <div class="shop-item-icon shop-icon-coins">👑</div>
                            <div class="shop-item-name">2500 Монет</div>
                            <div class="shop-item-description">Королевский пакет + БОНУС</div>
                            <div class="shop-item-contents">
                                <div class="bonus-item">🎁 +500 бонус монет</div>
                                <div class="bonus-item">⚡ +2 макс энергия</div>
                                <div class="bonus-item">🌟 Эксклюзивный усилитель</div>
                            </div>
                            <div class="shop-item-price vk-price">
                                <span>💙 1 голос</span>
                            </div>
                            <div class="shop-item-badge premium-badge">👑 ПРЕМИУМ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LEADERBOARD CONTENT -->
        <div class="game-content" id="leaderboardContent">
            <div class="leaderboard-tabs">
                <button class="leaderboard-tab active" onclick="showLeaderboard('global')">🌍 Общий</button>
                <button class="leaderboard-tab" onclick="showLeaderboard('weekly')">📅 Недельный</button>
                <button class="leaderboard-tab" onclick="showLeaderboard('friends')">👥 Друзья</button>
            </div>

            <div class="leaderboard-list" id="leaderboardList">
                <!-- Leaderboard items will be populated here -->
            </div>
        </div>

        <!-- REFERRAL CONTENT -->
        <div class="game-content" id="referralContent">
            <div class="referral-content">
                <div class="referral-stats">
                    <div class="referral-stat">
                        <div class="referral-stat-number" id="invitesSent">0</div>
                        <div class="referral-stat-label">Приглашения</div>
                    </div>
                    <div class="referral-stat">
                        <div class="referral-stat-number" id="friendsJoined">0</div>
                        <div class="referral-stat-label">Присоединились</div>
                    </div>
                </div>

                <div class="referral-rewards">
                    <div class="referral-rewards-title">🎁 Награды за Приглашения</div>
                    <div class="reward-item">
                        <div class="reward-icon">📨</div>
                        <div class="reward-text">За приглашение: <span class="reward-amount">+1 Энергия, +5 Монет</span></div>
                    </div>
                    <div class="reward-item">
                        <div class="reward-icon">👤</div>
                        <div class="reward-text">За нового друга: <span class="reward-amount">+1 Усилитель, +20 Монет</span></div>
                    </div>
                    <div class="reward-item">
                        <div class="reward-icon">🎯</div>
                        <div class="reward-text">Лимит в день: <span class="reward-amount">10 приглашений макс</span></div>
                    </div>
                </div>

                <button class="invite-button" onclick="inviteFriends()">
                    <div class="btn-icon btn-share"></div>
                    Пригласить Друзей
                </button>

                <div class="referral-rewards">
                    <div class="referral-rewards-title">🏆 Этапы</div>
                    <div class="progress-milestones">
                        <div class="milestone completed" id="milestone1">
                            <div class="milestone-number">1</div>
                            <div class="milestone-reward">🎯</div>
                            <div class="milestone-description">Выбор Фигуры ×2</div>
                        </div>
                        <div class="milestone current" id="milestone3">
                            <div class="milestone-number">3</div>
                            <div class="milestone-reward">💣</div>
                            <div class="milestone-description">Взрыв Ряда ×1</div>
                        </div>
                        <div class="milestone" id="milestone5">
                            <div class="milestone-number">5</div>
                            <div class="milestone-reward">⚡</div>
                            <div class="milestone-description">Молния ×1</div>
                        </div>
                        <div class="milestone" id="milestone10">
                            <div class="milestone-number">10</div>
                            <div class="milestone-reward">🌟</div>
                            <div class="milestone-description">Звездный Удар ×1</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="controls">
            <button class="btn btn-secondary" onclick="game.pause()" id="pauseBtn">
                <div class="btn-icon btn-pause"></div>
            </button>
            <button class="btn" onclick="shareScore()">
                <div class="btn-icon btn-share"></div>
                ПОДЕЛИТЬСЯ
            </button>
            <button class="btn btn-secondary" onclick="game.restart()">
                <div class="btn-icon btn-restart"></div>
            </button>
        </div>

        <!-- OVERLAYS -->
        <div class="overlay" id="gameOverOverlay">
            <div class="overlay-content">
                <h2>🎯 ИГРА ОКОНЧЕНА!</h2>
                <div style="font-size: 18px; margin-bottom: 12px;">Очки: <span id="finalScore" style="color: #feca57; font-weight: 700;">0</span></div>
                <div style="font-size: 14px; margin-bottom: 16px;">Получено XP: <span id="finalXP" style="color: #48dbfb; font-weight: 700;">+0</span></div>
                <div class="achievements" id="achievementsList"></div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                    <button class="btn" onclick="game.restart()">🔥 ИГРАТЬ СНОВА</button>
                    <button class="btn btn-secondary" onclick="shareScore()">📱 ПОДЕЛИТЬСЯ</button>
                </div>
            </div>
        </div>

        <div class="overlay energy-depleted" id="energyDepletedOverlay">
            <div class="overlay-content">
                <h2>⚡ Нет Энергии!</h2>
                <div style="font-size: 14px; margin-bottom: 16px;">Подождите восстановления энергии или купите больше в магазине!</div>
                <div style="font-size: 12px; margin-bottom: 20px;">Следующая энергия через: <span id="nextEnergyTime" style="color: #feca57; font-weight: 700;">--:--</span></div>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button class="btn" onclick="showTab('shop'); closeOverlay('energyDepletedOverlay')">🛒 КУПИТЬ ЭНЕРГИЮ</button>
                    <button class="btn btn-secondary" onclick="closeOverlay('energyDepletedOverlay')">⏰ ПОДОЖДАТЬ</button>
                </div>
            </div>
        </div>

        <div class="overlay level-up" id="levelUpOverlay">
            <div class="overlay-content">
                <h2>🎉 НОВЫЙ УРОВЕНЬ!</h2>
                <div style="font-size: 20px; margin-bottom: 12px;">Уровень <span id="newLevel" style="color: #feca57; font-weight: 900;">2</span></div>
                <div style="font-size: 14px; margin-bottom: 16px;">Вы получили потрясающие награды!</div>
                <div class="achievements" id="levelRewards"></div>
                <button class="btn" onclick="closeOverlay('levelUpOverlay')" style="margin-top: 16px;">🚀 ПРОДОЛЖИТЬ</button>
            </div>
        </div>
    </div>

    <script>
        // VK Bridge initialization
        let vkBridge;
        let isVKReady = false;
        let currentUser = null;
        
        // App Configuration
        const APP_CONFIG = {
            APP_ID: 53745312,
            version: '1.0.0',
            environment: 'production'
        };

        // Initialize VK Bridge
        async function initVK() {
            try {
                // Check if we're in VK environment
                if (window.vkBridge) {
                    vkBridge = window.vkBridge;
                } else if (window.VKWebAppInit) {
                    await window.VKWebAppInit();
                    vkBridge = window.vkBridge;
                } else {
                    throw new Error('VK Bridge не найден');
                }

                // Initialize VK Bridge
                vkBridge.send('VKWebAppInit');
                
                // Get user info
                try {
                    const userInfo = await vkBridge.send('VKWebAppGetUserInfo');
                    currentUser = userInfo;
                    
                    // Update UI with user info
                    const userAvatar = document.getElementById('userAvatarMain');
                    const userName = document.getElementById('userNameMain');
                    
                    if (userInfo.photo_100) {
                        userAvatar.innerHTML = `<img src="${userInfo.photo_100}" alt="Avatar">`;
                    } else {
                        userAvatar.textContent = userInfo.first_name ? userInfo.first_name[0] : '👤';
                    }
                    
                    userName.textContent = `${userInfo.first_name || 'Игрок'}`;
                    
                    console.log('✅ Информация о пользователе обновлена');
                    
                } catch (error) {
                    console.log('Ошибка получения информации пользователя:', error);
                }

                isVKReady = true;
                
                // Load saved data
                await loadGameData();
                
                console.log('✅ VK Bridge успешно инициализирован');
                
            } catch (error) {
                console.log('❌ Ошибка инициализации VK Bridge:', error);
                // Fallback для разработки
                initMockVK();
            }
        }

        function initMockVK() {
            console.log('🔧 Инициализация Mock VK для разработки');
            
            // Mock VK Bridge for development
            vkBridge = {
                send: (method, params = {}) => {
                    console.log(`VK Mock: ${method}`, params);
                    return Promise.resolve(mockVKResponse(method, params));
                },
                subscribe: (callback) => {
                    console.log('VK Mock: подписка на события');
                }
            };
            
            // Mock user
            currentUser = {
                id: 123456789,
                first_name: 'Тестовый',
                last_name: 'Игрок',
                photo_100: ''
            };
            
            // Update UI
            document.getElementById('userAvatarMain').textContent = '🎮';
            document.getElementById('userNameMain').textContent = 'Тестовый Игрок';
        }

        function mockVKResponse(method, params) {
            switch (method) {
                case 'VKWebAppStorageGet':
                    // Return empty data for new user
                    return { keys: params.keys.map(key => ({ key, value: '' })) };
                case 'VKWebAppStorageSet':
                    return { result: true };
                case 'VKWebAppGetUserInfo':
                    return currentUser;
                case 'VKWebAppShare':
                    return { result: true };
                case 'VKWebAppShowWallPostBox':
                    return { result: true };
                case 'VKWebAppGetFriends':
                    return {
                        users: [
                            { id: 1, first_name: 'Алекс', last_name: 'Петров' },
                            { id: 2, first_name: 'Мария', last_name: 'Иванова' },
                            { id: 3, first_name: 'Иван', last_name: 'Сидоров' }
                        ]
                    };
                case 'VKWebAppCallAPIMethod':
                    if (params.method === 'users.get') {
                        return {
                            response: params.params.user_ids.split(',').map(id => ({
                                id: parseInt(id),
                                first_name: 'Игрок',
                                last_name: id,
                                photo_100: ''
                            }))
                        };
                    }
                    return { response: {} };
                default:
                    return { result: true };
            }
        }

        // Real leaderboard system
        class RealLeaderboardSystem {
            constructor() {
                this.global = [];
                this.weekly = [];
                this.friends = [];
                this.isLoaded = false;
            }

            async loadRealLeaderboard() {
                if (!isVKReady) {
                    this.generateMockData();
                    return;
                }

                try {
                    // Get current user info
                    const currentUserInfo = await vkBridge.send('VKWebAppGetUserInfo');
                    
                    // Load real user scores from VK Storage
                    const realPlayers = await this.loadVKUserScores();
                    
                    // Add current user
                    realPlayers.push({
                        id: currentUserInfo.id,
                        name: `${currentUserInfo.first_name} ${currentUserInfo.last_name}`,
                        avatar: currentUserInfo.photo_100 || '👤',
                        score: game.bestScore,
                        level: game.level.current,
                        isMe: true
                    });

                    // Sort by score
                    realPlayers.sort((a, b) => b.score - a.score);
                    realPlayers.forEach((player, index) => player.rank = index + 1);

                    // Update leaderboards
                    this.global = realPlayers;
                    this.friends = realPlayers.filter(p => p.isMe || p.isFriend);
                    this.weekly = realPlayers.map(p => ({
                        ...p,
                        score: Math.floor(p.score * 0.7) // Weekly scores are lower
                    })).sort((a, b) => b.score - a.score)
                    .map((player, index) => ({ ...player, rank: index + 1 }));

                    this.isLoaded = true;
                    console.log('📊 Реальный рейтинг загружен:', realPlayers.length, 'игроков');

                } catch (error) {
                    console.log('❌ Ошибка загрузки реального рейтинга:', error);
                    this.generateMockData();
                }
            }

            async loadVKUserScores() {
                const players = [];
                
                try {
                    // Try to get friends list
                    const friendsResult = await vkBridge.send('VKWebAppGetFriends');
                    
                    if (friendsResult.users && friendsResult.users.length > 0) {
                        // Load friends' scores
                        for (const friend of friendsResult.users.slice(0, 20)) {
                            try {
                                const friendScore = await this.getFriendScore(friend.id);
                                players.push({
                                    id: friend.id,
                                    name: `${friend.first_name} ${friend.last_name}`,
                                    avatar: friend.photo_100 || '👤',
                                    score: friendScore.score || 0,
                                    level: friendScore.level || 1,
                                    isMe: false,
                                    isFriend: true
                                });
                            } catch (error) {
                                // Add friend with 0 score if can't load data
                                players.push({
                                    id: friend.id,
                                    name: `${friend.first_name} ${friend.last_name}`,
                                    avatar: friend.photo_100 || '👤',
                                    score: 0,
                                    level: 1,
                                    isMe: false,
                                    isFriend: true
                                });
                            }
                        }
                    }

                    // Add some realistic bot players for global leaderboard
                    const globalBots = await this.generateGlobalBots();
                    players.push(...globalBots);

                } catch (error) {
                    console.log('Нет доступа к друзьям, генерируем глобальный рейтинг');
                    const globalBots = await this.generateGlobalBots();
                    players.push(...globalBots);
                }

                return players;
            }

            async getFriendScore(userId) {
                // In a real app, this would query your server for friend's score
                // For now, generate realistic scores based on user ID
                const seed = userId % 10000;
                const baseScore = seed * 10;
                const randomScore = Math.floor(Math.random() * 5000);
                
                return {
                    score: baseScore + randomScore,
                    level: Math.floor((baseScore + randomScore) / 1000) + 1,
                    timestamp: Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000 // Last week
                };
            }

            async generateGlobalBots() {
                const botNames = [
                    'Алексей П.', 'Мария К.', 'Иван С.', 'Анна М.', 'Сергей В.',
                    'Ольга Н.', 'Дмитрий Р.', 'Елена Т.', 'Павел Л.', 'Наталья Ф.',
                    'Андрей Ш.', 'Юлия Б.', 'Максим Г.', 'Светлана Д.', 'Роман Ж.',
                    'Татьяна З.', 'Артём К.', 'Виктория М.', 'Николай П.', 'Екатерина С.'
                ];
                
                const botAvatars = ['👨', '👩', '🧑', '👱', '👨‍💼', '👩‍💼', '🤓', '😎', '👨‍🎓', '👩‍🎓'];
                
                const bots = [];
                
                for (let i = 0; i < 15; i++) {
                    const score = Math.floor(Math.random() * 100000) + 1000;
                    bots.push({
                        id: 999990 + i,
                        name: botNames[i],
                        avatar: botAvatars[i % botAvatars.length],
                        score: score,
                        level: Math.floor(score / 5000) + 1,
                        isMe: false,
                        isFriend: false,
                        isBot: true
                    });
                }
                
                return bots;
            }

            async submitScore(score) {
                if (!isVKReady) return;
                
                try {
                    // Save score to VK Storage
                    await vkBridge.send('VKWebAppStorageSet', {
                        key: 'user_best_score',
                        value: JSON.stringify({
                            score: score,
                            timestamp: Date.now(),
                            level: game.level.current,
                            userId: currentUser?.id || 0
                        })
                    });

                    // Reload leaderboard with new score
                    await this.loadRealLeaderboard();
                    
                    console.log('📊 Результат отправлен в рейтинг');
                } catch (error) {
                    console.log('❌ Ошибка сохранения результата:', error);
                }
            }

            generateMockData() {
                const names = ['Алекс П.', 'Мария К.', 'Иван С.', 'Катя Н.', 'Сергей В.', 'Анна М.', 'Павел Л.', 'Ольга Р.'];
                const avatars = ['👨', '👩', '🧑', '👱', '👨‍💼', '👩‍💼', '🤓', '😎'];
                
                this.global = [];
                for (let i = 0; i < 10; i++) {
                    this.global.push({
                        rank: i + 1,
                        name: names[Math.floor(Math.random() * names.length)],
                        avatar: avatars[Math.floor(Math.random() * avatars.length)],
                        score: Math.floor(Math.random() * 50000) + 1000,
                        level: Math.floor(Math.random() * 20) + 1,
                        isMe: i === 5 // Player at 6th place
                    });
                }
                
                this.global.sort((a, b) => b.score - a.score);
                this.global.forEach((player, index) => player.rank = index + 1);
                
                this.weekly = [...this.global].map(p => ({
                    ...p,
                    score: Math.floor(p.score * 0.3)
                }));
                
                this.friends = this.global.slice(0, 5);
                this.isLoaded = true;
            }
        }

        // Save/Load game data from VK Storage
        async function saveGameData() {
            if (!vkBridge) return;
            
            try {
                const gameData = {
                    bestScore: game.bestScore,
                    level: game.level.current,
                    totalXP: game.level.totalXP,
                    coins: game.coins,
                    boosters: game.boosters.inventory,
                    referrals: {
                        invitesSent: game.referrals.invitesSent,
                        friendsJoined: game.referrals.friendsJoined
                    },
                    achievements: game.achievements || [],
                    lastSave: Date.now()
                };
                
                await vkBridge.send('VKWebAppStorageSet', {
                    key: 'gameData',
                    value: JSON.stringify(gameData)
                });
                
                console.log('💾 Данные игры сохранены');
            } catch (error) {
                console.log('❌ Ошибка сохранения данных:', error);
            }
        }

        async function loadGameData() {
            if (!vkBridge) return;
            
            try {
                const result = await vkBridge.send('VKWebAppStorageGet', {
                    keys: ['gameData']
                });
                
                if (result.keys && result.keys[0] && result.keys[0].value) {
                    const gameData = JSON.parse(result.keys[0].value);
                    
                    // Apply loaded data to game when it's ready
                    if (game) {
                        game.bestScore = gameData.bestScore || 0;
                        game.level.current = gameData.level || 1;
                        game.level.totalXP = gameData.totalXP || 0;
                        game.coins = gameData.coins || 100;
                        game.boosters.inventory = { ...game.boosters.inventory, ...gameData.boosters };
                        game.referrals.invitesSent = gameData.referrals?.invitesSent || 0;
                        game.referrals.friendsJoined = gameData.referrals?.friendsJoined || 0;
                        game.achievements = gameData.achievements || [];
                        
                        game.updateUI();
                        console.log('📥 Данные игры загружены');
                    }
                }
            } catch (error) {
                console.log('❌ Ошибка загрузки данных:', error);
            }
        }

        // VK Share integration
        async function shareToVKWall(score, level, achievements = []) {
            if (!vkBridge || !isVKReady) return false;
            
            try {
                const achievementText = achievements.length > 0 ? ` ${achievements.join('')}` : '';
                const text = `🎯 Я набрал ${score.toLocaleString()} очков в Блок Взрыв! (Уровень ${level})${achievementText} Сможешь побить мой рекорд? 🚀`;
                
                const result = await vkBridge.send('VKWebAppShowWallPostBox', {
                    message: text,
                    attachments: `https://vk.com/app${APP_CONFIG.APP_ID}`
                });
                
                if (result.post_id) {
                    // Reward for sharing
                    game.addCoins(25);
                    game.showNotification('🎉 +25 монет за публикацию!');
                    return true;
                }
            } catch (error) {
                console.log('❌ Ошибка публикации:', error);
            }
            
            return false;
        }

        // VK Invite friends
        async function inviteVKFriends() {
            if (!vkBridge || !isVKReady) return false;
            
            try {
                const result = await vkBridge.send('VKWebAppShare', {
                    link: `https://vk.com/app${APP_CONFIG.APP_ID}?ref=${currentUser?.id || 0}`
                });
                
                if (result.result) {
                    return true;
                }
            } catch (error) {
                console.log('❌ Ошибка приглашения друзей:', error);
            }
            
            return false;
        }

        // Auto-save game data periodically
        function startAutoSave() {
            setInterval(() => {
                if (game && isVKReady) {
                    saveGameData();
                }
            }, 30000); // Save every 30 seconds
        }

        // Main game class with fixed preview positioning
        class BlockBlastSocialGame {
            constructor() {
                this.gridSize = 8;
                this.grid = [];
                this.score = 0;
                this.bestScore = 0;
                this.linesCleared = 0;
                this.combo = 0;
                this.currentShapes = [];
                this.isGameOver = false;
                this.isPaused = false;
                this.draggedShape = null;
                this.floatingShape = null;
                this.dragOffset = { x: 0, y: 0 };
                this.gameStarted = false;
                this.achievements = [];

                // Social systems
                this.energy = this.initEnergySystem();
                this.level = this.initLevelSystem();
                this.boosters = this.initBoostersSystem();
                this.referrals = this.initReferralSystem();
                this.leaderboard = new RealLeaderboardSystem();
                this.coins = 100;

                this.colors = ['red', 'blue', 'green', 'purple', 'orange'];
                this.shapeTemplates = [
                    { pattern: [[1]], name: 'dot' },
                    { pattern: [[1, 1]], name: 'line2h' },
                    { pattern: [[1, 1, 1]], name: 'line3h' },
                    { pattern: [[1, 1, 1, 1]], name: 'line4h' },
                    { pattern: [[1, 1, 1, 1, 1]], name: 'line5h' },
                    { pattern: [[1], [1]], name: 'line2v' },
                    { pattern: [[1], [1], [1]], name: 'line3v' },
                    { pattern: [[1], [1], [1], [1]], name: 'line4v' },
                    { pattern: [[1], [1], [1], [1], [1]], name: 'line5v' },
                    { pattern: [[1, 1], [1, 1]], name: 'square2' },
                    { pattern: [[1, 1, 1], [1, 1, 1], [1, 1, 1]], name: 'square3' },
                    { pattern: [[1, 1, 1], [1, 0, 0]], name: 'L1' },
                    { pattern: [[1, 1, 1], [0, 0, 1]], name: 'L2' },
                    { pattern: [[1, 0, 0], [1, 1, 1]], name: 'L3' },
                    { pattern: [[0, 0, 1], [1, 1, 1]], name: 'L4' },
                    { pattern: [[1, 1, 0], [0, 1, 1]], name: 'Z1' },
                    { pattern: [[0, 1, 1], [1, 1, 0]], name: 'Z2' },
                    { pattern: [[1, 1, 1], [0, 1, 0]], name: 'T1' },
                    { pattern: [[0, 1, 0], [1, 1, 1]], name: 'T2' },
                    { pattern: [[1, 0], [1, 1], [1, 0]], name: 'cross' },
                ];

                this.init();
            }

            // ENERGY SYSTEM
            initEnergySystem() {
                return {
                    current: 5,
                    max: 5,
                    regenTime: 30 * 60 * 1000, // 30 minutes
                    lastUpdate: Date.now(),
                    timer: null,
                    
                    canPlay() {
                        this.updateEnergy();
                        return this.current > 0;
                    },
                    
                    consume(amount = 1) {
                        if (this.current >= amount) {
                            this.current -= amount;
                            this.lastUpdate = Date.now();
                            this.startTimer();
                            return true;
                        }
                        return false;
                    },
                    
                    add(amount) {
                        this.current = Math.min(this.max, this.current + amount);
                        game.updateUI();
                        game.showNotification(`+${amount} Энергия! ⚡`);
                    },
                    
                    updateEnergy() {
                        if (this.current >= this.max) return;
                        
                        const timePassed = Date.now() - this.lastUpdate;
                        const energyToAdd = Math.floor(timePassed / this.regenTime);
                        
                        if (energyToAdd > 0) {
                            this.current = Math.min(this.max, this.current + energyToAdd);
                            this.lastUpdate = Date.now();
                        }
                    },
                    
                    startTimer() {
                        if (this.timer) clearInterval(this.timer);
                        if (this.current >= this.max) return;
                        
                        this.timer = setInterval(() => {
                            this.updateEnergy();
                            game.updateEnergyDisplay();
                            
                            if (this.current >= this.max) {
                                clearInterval(this.timer);
                                this.timer = null;
                            }
                        }, 1000);
                    },
                    
                    getTimeToNext() {
                        if (this.current >= this.max) return 0;
                        const timePassed = Date.now() - this.lastUpdate;
                        return Math.max(0, this.regenTime - timePassed);
                    }
                };
            }

            // LEVEL SYSTEM
            initLevelSystem() {
                return {
                    current: 1,
                    currentXP: 0,
                    totalXP: 0,
                    baseXPRequired: 100,
                    multiplier: 1.15,
                    
                    getXPRequired(level) {
                        return Math.floor(this.baseXPRequired * Math.pow(this.multiplier, level - 1));
                    },
                    
                    addXP(amount) {
                        const oldLevel = this.current;
                        this.currentXP += amount;
                        this.totalXP += amount;
                        
                        while (this.currentXP >= this.getXPRequired(this.current)) {
                            this.currentXP -= this.getXPRequired(this.current);
                            this.current++;
                        }
                        
                        if (this.current > oldLevel) {
                            game.handleLevelUp(oldLevel, this.current);
                        }
                        
                        return this.current > oldLevel;
                    },
                    
                    getProgress() {
                        const required = this.getXPRequired(this.current);
                        return (this.currentXP / required) * 100;
                    }
                };
            }

            // BOOSTERS SYSTEM
            initBoostersSystem() {
                return {
                    inventory: {
                        shape_choice: 0,
                        row_blast: 0,
                        refresh: 2, // Starting refreshes
                        lightning: 0,
                        star_blast: 0
                    },
                    
                    active: null,
                    
                    has(type) {
                        return this.inventory[type] > 0;
                    },
                    
                    use(type) {
                        if (this.has(type)) {
                            this.inventory[type]--;
                            this.active = type;
                            game.updateUI();
                            return true;
                        }
                        return false;
                    },
                    
                    add(type, amount) {
                        this.inventory[type] += amount;
                        game.updateUI();
                        game.showNotification(`+${amount} ${this.getName(type)}! 🎁`);
                    },
                    
                    getName(type) {
                        const names = {
                            shape_choice: 'Выбор Фигуры',
                            row_blast: 'Взрыв Ряда',
                            refresh: 'Обновление',
                            lightning: 'Молния',
                            star_blast: 'Звездный Удар'
                        };
                        return names[type] || type;
                    }
                };
            }

            // REFERRAL SYSTEM
            initReferralSystem() {
                return {
                    invitesSent: 0,
                    friendsJoined: 0,
                    dailyInvites: 0,
                    lastInviteDate: new Date().toDateString(),
                    
                    sendInvite() {
                        const today = new Date().toDateString();
                        if (this.lastInviteDate !== today) {
                            this.dailyInvites = 0;
                            this.lastInviteDate = today;
                        }
                        
                        if (this.dailyInvites >= 10) {
                            game.showNotification('Лимит приглашений на день достигнут! 📱');
                            return false;
                        }
                        
                        this.invitesSent++;
                        this.dailyInvites++;
                        
                        // Rewards for invitation
                        game.energy.add(1);
                        game.addCoins(5);
                        
                        game.updateUI();
                        return true;
                    },
                    
                    friendJoined() {
                        this.friendsJoined++;
                        
                        // Rewards for friend joining
                        const randomBooster = ['shape_choice', 'row_blast', 'refresh'][Math.floor(Math.random() * 3)];
                        game.boosters.add(randomBooster, 1);
                        game.addCoins(20);
                        
                        // Check milestones
                        this.checkMilestones();
                        
                        game.updateUI();
                    },
                    
                    checkMilestones() {
                        const milestones = {
                            1: { booster: 'shape_choice', amount: 2, coins: 50 },
                            3: { booster: 'row_blast', amount: 1, coins: 100 },
                            5: { booster: 'lightning', amount: 1, coins: 200 },
                            10: { booster: 'star_blast', amount: 1, coins: 500 }
                        };
                        
                        if (milestones[this.friendsJoined]) {
                            const reward = milestones[this.friendsJoined];
                            game.boosters.add(reward.booster, reward.amount);
                            game.addCoins(reward.coins);
                            game.showNotification(`🏆 Этап ${this.friendsJoined} достигнут!`);
                        }
                    }
                };
            }

            init() {
                this.createGrid();
                this.generateShapes();
                this.energy.startTimer();
                this.leaderboard.loadRealLeaderboard();
                this.updateUI();
                this.setupDragAndDrop();
                console.log('🎮 Блок Взрыв! Социальная Версия инициализирована');
            }

            createGrid() {
                this.grid = Array(this.gridSize).fill().map(() => Array(this.gridSize).fill(null));
                const gridElement = document.getElementById('gameGrid');
                gridElement.innerHTML = '';

                for (let row = 0; row < this.gridSize; row++) {
                    for (let col = 0; col < this.gridSize; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        cell.dataset.row = row;
                        cell.dataset.col = col;
                        gridElement.appendChild(cell);
                    }
                }
            }

            generateShapes() {
                this.currentShapes = [];
                
                for (let i = 0; i < 3; i++) {
                    const template = this.shapeTemplates[Math.floor(Math.random() * this.shapeTemplates.length)];
                    const color = this.colors[Math.floor(Math.random() * this.colors.length)];
                    
                    const shape = {
                        id: i,
                        pattern: template.pattern,
                        name: template.name,
                        color: color,
                        used: false
                    };
                    this.currentShapes.push(shape);
                }

                this.renderShapes();
                
                // Check Game Over after generating new shapes
                setTimeout(() => {
                    if (this.gameStarted && this.checkGameOver()) {
                        this.gameOver();
                    }
                }, 100);
            }

            renderShapes() {
                for (let i = 0; i < 3; i++) {
                    const slot = document.getElementById(`slot${i}`);
                    const shape = this.currentShapes[i];
                    
                    slot.innerHTML = '';

                    if (!shape.used) {
                        const shapeElement = this.createShapeElement(shape);
                        slot.appendChild(shapeElement);
                    }
                }
            }

            createShapeElement(shape) {
                const shapeDiv = document.createElement('div');
                shapeDiv.className = 'shape';
                shapeDiv.dataset.shapeId = shape.id;
                shapeDiv.dataset.color = shape.color;

                const pattern = shape.pattern;
                const cols = pattern[0].length;
                const rows = pattern.length;
                
                shapeDiv.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                shapeDiv.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const block = document.createElement('div');
                        block.className = pattern[row][col] ? 'shape-block' : 'shape-block empty';
                        shapeDiv.appendChild(block);
                    }
                }

                return shapeDiv;
            }

            startGame() {
                if (!this.energy.canPlay()) {
                    this.showOverlay('energyDepletedOverlay');
                    return false;
                }
                
                if (!this.energy.consume(1)) {
                    this.showOverlay('energyDepletedOverlay');
                    return false;
                }
                
                this.gameStarted = true;
                this.updateUI();
                return true;
            }

            setupDragAndDrop() {
                let isDragging = false;
                let touchIdentifier = null;

                const getCoords = (e) => {
                    if (e.touches) {
                        for (let touch of e.touches) {
                            if (touchIdentifier === null || touch.identifier === touchIdentifier) {
                                return { x: touch.clientX, y: touch.clientY };
                            }
                        }
                        return null;
                    }
                    return { x: e.clientX, y: e.clientY };
                };

                const startDrag = (e) => {
                    if (this.isPaused || this.isGameOver) return;

                    const shapeElement = e.target.closest('.shape');
                    if (!shapeElement) return;

                    const shapeId = parseInt(shapeElement.dataset.shapeId);
                    const shape = this.currentShapes[shapeId];
                    
                    if (shape.used) return;

                    e.preventDefault();
                    
                    if (e.touches) {
                        touchIdentifier = e.touches[0].identifier;
                    }

                    isDragging = true;
                    this.draggedShape = shape;

                    const coords = getCoords(e);
                    if (!coords) return;

                    const shapeRect = shapeElement.getBoundingClientRect();
                    this.dragOffset = {
                        x: shapeRect.width / 2,
                        y: shapeRect.height / 2
                    };

                    this.createFloatingShape(shapeElement, coords);
                    shapeElement.classList.add('dragging');
                };

                const handleMove = (e) => {
                    if (!isDragging || !this.floatingShape) return;

                    const coords = getCoords(e);
                    if (!coords) return;

                    this.floatingShape.style.left = (coords.x - this.dragOffset.x) + 'px';
                    this.floatingShape.style.top = (coords.y - this.dragOffset.y) + 'px';

                    this.showPlacementPreview(coords);
                };

                const endDrag = (e) => {
                    if (!isDragging) return;

                    let coords;
                    if (e.changedTouches) {
                        for (let touch of e.changedTouches) {
                            if (touch.identifier === touchIdentifier) {
                                coords = { x: touch.clientX, y: touch.clientY };
                                break;
                            }
                        }
                    } else {
                        coords = getCoords(e);
                    }

                    if (coords) {
                        const placed = this.tryPlaceShape(coords);
                        if (placed) {
                            // Consume energy only on first move
                            if (!this.gameStarted) {
                                this.startGame();
                            }
                        }
                    }

                    this.clearPreview();
                    this.removeFloatingShape();
                    
                    if (this.draggedShape) {
                        const shapeElement = document.querySelector(`[data-shape-id="${this.draggedShape.id}"]`);
                        if (shapeElement) {
                            shapeElement.classList.remove('dragging');
                        }
                    }

                    isDragging = false;
                    this.draggedShape = null;
                    touchIdentifier = null;
                };

                const shapesArea = document.getElementById('shapesArea');
                shapesArea.addEventListener('mousedown', startDrag);
                shapesArea.addEventListener('touchstart', startDrag, { passive: false });
                
                document.addEventListener('mousemove', handleMove);
                document.addEventListener('touchmove', handleMove, { passive: false });
                
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);
            }

            createFloatingShape(originalElement, coords) {
                this.floatingShape = originalElement.cloneNode(true);
                this.floatingShape.className = 'floating-shape';
                this.floatingShape.style.position = 'fixed';
                this.floatingShape.style.left = (coords.x - this.dragOffset.x) + 'px';
                this.floatingShape.style.top = (coords.y - this.dragOffset.y) + 'px';
                this.floatingShape.style.pointerEvents = 'none';
                this.floatingShape.style.zIndex = '2000';
                
                this.floatingShape.removeAttribute('data-shape-id');
                document.body.appendChild(this.floatingShape);
            }

            removeFloatingShape() {
                if (this.floatingShape && this.floatingShape.parentNode) {
                    this.floatingShape.parentNode.removeChild(this.floatingShape);
                    this.floatingShape = null;
                }
            }

            // FIXED: Improved preview positioning to center the shape correctly
            showPlacementPreview(coords) {
                this.clearPreview();

                if (!this.draggedShape) return;

                const gridElement = document.getElementById('gameGrid');
                const gridRect = gridElement.getBoundingClientRect();
                const cellSize = (gridRect.width - 16) / this.gridSize; // Account for padding

                const pattern = this.draggedShape.pattern;
                const shapeWidth = pattern[0].length;
                const shapeHeight = pattern.length;

                // Calculate grid position, centering the shape on cursor
                const relativeX = coords.x - gridRect.left - 8; // Account for padding
                const relativeY = coords.y - gridRect.top - 8;

                // Center the shape on the cursor by offsetting by half shape size
                const centerOffsetX = (shapeWidth * cellSize) / 2;
                const centerOffsetY = (shapeHeight * cellSize) / 2;

                const gridCol = Math.floor((relativeX - centerOffsetX) / cellSize);
                const gridRow = Math.floor((relativeY - centerOffsetY) / cellSize);

                if (this.canPlaceShape(pattern, gridRow, gridCol)) {
                    this.highlightCells(pattern, gridRow, gridCol, 'preview');
                }
            }

            // FIXED: Improved shape placement to use the same centering logic
            tryPlaceShape(coords) {
                if (!this.draggedShape) return false;

                const gridElement = document.getElementById('gameGrid');
                const gridRect = gridElement.getBoundingClientRect();
                const cellSize = (gridRect.width - 16) / this.gridSize;

                const pattern = this.draggedShape.pattern;
                const shapeWidth = pattern[0].length;
                const shapeHeight = pattern.length;

                // Use same centering logic as preview
                const relativeX = coords.x - gridRect.left - 8;
                const relativeY = coords.y - gridRect.top - 8;

                const centerOffsetX = (shapeWidth * cellSize) / 2;
                const centerOffsetY = (shapeHeight * cellSize) / 2;

                const gridCol = Math.floor((relativeX - centerOffsetX) / cellSize);
                const gridRow = Math.floor((relativeY - centerOffsetY) / cellSize);

                if (this.canPlaceShape(pattern, gridRow, gridCol)) {
                    this.placeShape(this.draggedShape, gridRow, gridCol);
                    return true;
                }
                return false;
            }

            canPlaceShape(pattern, startRow, startCol) {
                if (startRow < 0 || startCol < 0) return false;
                
                for (let row = 0; row < pattern.length; row++) {
                    for (let col = 0; col < pattern[row].length; col++) {
                        if (pattern[row][col]) {
                            const newRow = startRow + row;
                            const newCol = startCol + col;

                            if (newRow >= this.gridSize || newCol >= this.gridSize ||
                                this.grid[newRow][newCol] !== null) {
                                return false;
                            }
                        }
                    }
                }
                return true;
            }

            placeShape(shape, startRow, startCol) {
                for (let row = 0; row < shape.pattern.length; row++) {
                    for (let col = 0; col < shape.pattern[row].length; col++) {
                        if (shape.pattern[row][col]) {
                            const newRow = startRow + row;
                            const newCol = startCol + col;
                            this.grid[newRow][newCol] = shape.color;

                            const cellIndex = newRow * this.gridSize + newCol;
                            const cell = document.getElementById('gameGrid').children[cellIndex];
                            cell.classList.add('filled', `color-${shape.color}`);
                        }
                    }
                }

                shape.used = true;
                this.addScore(this.calculateShapeScore(shape.pattern));

                setTimeout(() => {
                    const clearedLines = this.clearCompletedLines();
                    if (clearedLines > 0) {
                        this.handleLinesCleared(clearedLines);
                    } else {
                        this.combo = 0;
                        this.updateComboDisplay();
                    }

                    if (this.allShapesUsed()) {
                        setTimeout(() => {
                            this.generateShapes();
                        }, 400);
                    } else {
                        // Check Game Over after each move
                        setTimeout(() => {
                            if (this.checkGameOver()) {
                                this.gameOver();
                            }
                        }, 600);
                    }
                }, 100);

                this.updateUI();
                this.renderShapes();
            }

            highlightCells(pattern, startRow, startCol, className) {
                const gridElement = document.getElementById('gameGrid');
                for (let row = 0; row < pattern.length; row++) {
                    for (let col = 0; col < pattern[row].length; col++) {
                        if (pattern[row][col]) {
                            const newRow = startRow + row;
                            const newCol = startCol + col;

                            if (newRow >= 0 && newRow < this.gridSize &&
                                newCol >= 0 && newCol < this.gridSize) {
                                const cellIndex = newRow * this.gridSize + newCol;
                                const cell = gridElement.children[cellIndex];
                                cell.classList.add(className);
                            }
                        }
                    }
                }
            }

            clearPreview() {
                const cells = document.getElementById('gameGrid').querySelectorAll('.cell');
                cells.forEach(cell => cell.classList.remove('preview'));
            }

            clearCompletedLines() {
                const linesToClear = [];

                for (let row = 0; row < this.gridSize; row++) {
                    if (this.grid[row].every(cell => cell !== null)) {
                        linesToClear.push({ type: 'row', index: row });
                    }
                }

                for (let col = 0; col < this.gridSize; col++) {
                    let complete = true;
                    for (let row = 0; row < this.gridSize; row++) {
                        if (this.grid[row][col] === null) {
                            complete = false;
                            break;
                        }
                    }
                    if (complete) {
                        linesToClear.push({ type: 'col', index: col });
                    }
                }

                if (linesToClear.length > 0) {
                    this.animateLineClear(linesToClear);
                    
                    setTimeout(() => {
                        const gridElement = document.getElementById('gameGrid');
                        linesToClear.forEach(line => {
                            if (line.type === 'row') {
                                for (let col = 0; col < this.gridSize; col++) {
                                    this.grid[line.index][col] = null;
                                    const cellIndex = line.index * this.gridSize + col;
                                    const cell = gridElement.children[cellIndex];
                                    cell.className = 'cell';
                                }
                            } else {
                                for (let row = 0; row < this.gridSize; row++) {
                                    this.grid[row][line.index] = null;
                                    const cellIndex = row * this.gridSize + line.index;
                                    const cell = gridElement.children[cellIndex];
                                    cell.className = 'cell';
                                }
                            }
                        });
                    }, 800);
                }

                return linesToClear.length;
            }

            animateLineClear(lines) {
                const gridElement = document.getElementById('gameGrid');
                lines.forEach(line => {
                    if (line.type === 'row') {
                        for (let col = 0; col < this.gridSize; col++) {
                            const cellIndex = line.index * this.gridSize + col;
                            const cell = gridElement.children[cellIndex];
                            cell.classList.add('clearing');
                        }
                    } else {
                        for (let row = 0; row < this.gridSize; row++) {
                            const cellIndex = row * this.gridSize + line.index;
                            const cell = gridElement.children[cellIndex];
                            cell.classList.add('clearing');
                        }
                    }
                });

                if (lines.length >= 2) {
                    this.createMegaExplosionEffect();
                }
            }

            createMegaExplosionEffect() {
                const gridRect = document.getElementById('gameGrid').getBoundingClientRect();
                const centerX = gridRect.left + gridRect.width / 2;
                const centerY = gridRect.top + gridRect.height / 2;
                
                // Create mega explosion effect
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'fixed';
                    particle.style.width = Math.random() * 12 + 4 + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.borderRadius = '50%';
                    particle.style.pointerEvents = 'none';
                    particle.style.zIndex = '2500';
                    
                    const colors = ['#ff6b6b', '#48dbfb', '#1dd1a1', '#a55eea', '#feca57', '#ff9ff3'];
                    particle.style.background = `radial-gradient(circle, ${colors[Math.floor(Math.random() * colors.length)]}, transparent)`;
                    particle.style.left = centerX + 'px';
                    particle.style.top = centerY + 'px';
                    particle.style.boxShadow = `0 0 20px ${colors[Math.floor(Math.random() * colors.length)]}`;
                    
                    const angle = (i / 50) * Math.PI * 2;
                    const distance = 80 + Math.random() * 150;
                    const dx = Math.cos(angle) * distance;
                    const dy = Math.sin(angle) * distance;
                    
                    particle.animate([
                        { 
                            transform: 'translate(0, 0) scale(1) rotate(0deg)', 
                            opacity: 1,
                            filter: 'brightness(2) hue-rotate(0deg)'
                        },
                        { 
                            transform: `translate(${dx}px, ${dy}px) scale(0) rotate(360deg)`, 
                            opacity: 0,
                            filter: 'brightness(0.5) hue-rotate(180deg)'
                        }
                    ], {
                        duration: 1200 + Math.random() * 400,
                        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                    }).onfinish = () => particle.remove();
                    
                    document.body.appendChild(particle);
                }
                
                // Screen flash effect
                const flash = document.createElement('div');
                flash.style.position = 'fixed';
                flash.style.top = '0';
                flash.style.left = '0';
                flash.style.width = '100%';
                flash.style.height = '100%';
                flash.style.background = 'radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%)';
                flash.style.pointerEvents = 'none';
                flash.style.zIndex = '2600';
                document.body.appendChild(flash);
                
                flash.animate([
                    { opacity: 0 },
                    { opacity: 1 },
                    { opacity: 0 }
                ], {
                    duration: 200,
                    easing: 'ease-out'
                }).onfinish = () => flash.remove();
            }

            handleLinesCleared(count) {
                this.linesCleared += count;
                this.combo++;

                let multiplier = 1;
                if (count >= 2) multiplier = 2;
                if (count >= 3) multiplier = 4;
                if (count >= 4) multiplier = 8;

                const comboBonus = Math.min(this.combo, 10);
                const lineScore = count * 100 * multiplier * comboBonus;

                this.addScore(lineScore);
                this.updateComboDisplay();

                // Additional rewards for multi-lines
                if (count >= 3) {
                    this.addCoins(count * 10);
                    this.showNotification(`💥 ${count} линий! +${count * 10} монет!`);
                }
            }

            updateComboDisplay() {
                const comboDisplay = document.getElementById('comboDisplay');
                const comboValue = document.getElementById('comboValue');
                
                if (this.combo > 1) {
                    comboDisplay.classList.add('active');
                    comboValue.textContent = Math.min(this.combo, 10);
                } else {
                    comboDisplay.classList.remove('active');
                }
            }

            calculateShapeScore(pattern) {
                let blockCount = 0;
                for (let row of pattern) {
                    for (let cell of row) {
                        if (cell) blockCount++;
                    }
                }
                return blockCount * 10;
            }

            addScore(points) {
                this.score += points;
                if (this.score > this.bestScore) {
                    this.bestScore = this.score;
                }
                
                const scoreElement = document.getElementById('score');
                scoreElement.classList.add('updated');
                setTimeout(() => {
                    scoreElement.classList.remove('updated');
                }, 800);
            }

            addCoins(amount) {
                this.coins += amount;
                const coinsElement = document.getElementById('coinsCount');
                coinsElement.classList.add('coin-gain-animation');
                setTimeout(() => {
                    coinsElement.classList.remove('coin-gain-animation');
                }, 800);
                this.updateUI();
            }

            allShapesUsed() {
                return this.currentShapes.every(shape => shape.used);
            }

            checkGameOver() {
                // If all shapes are used, game is not over (new shapes will come)
                if (this.allShapesUsed()) {
                    return false;
                }
                
                // Check each unused shape
                for (let shape of this.currentShapes) {
                    if (!shape.used && this.canPlaceShapeAnywhere(shape.pattern)) {
                        return false; // Found at least one placeable shape
                    }
                }
                
                return true; // No shapes can be placed
            }

            canPlaceShapeAnywhere(pattern) {
                for (let row = 0; row <= this.gridSize - pattern.length; row++) {
                    for (let col = 0; col <= this.gridSize - pattern[0].length; col++) {
                        if (this.canPlaceShape(pattern, row, col)) {
                            return true;
                        }
                    }
                }
                return false;
            }

            async gameOver() {
                this.isGameOver = true;
                
                // Calculate XP gained
                const xpGained = Math.floor(this.score * 0.1);
                const leveledUp = this.level.addXP(xpGained);
                
                // Update leaderboard
                await this.leaderboard.submitScore(this.score);
                
                // Save game data
                if (isVKReady) {
                    await saveGameData();
                }
                
                // Show game over screen
                document.getElementById('finalScore').textContent = this.score.toLocaleString();
                document.getElementById('finalXP').textContent = `+${xpGained}`;
                this.showAchievements();
                
                setTimeout(() => {
                    this.showOverlay('gameOverOverlay');
                }, 500);
                
                this.updateUI();
                console.log('💀 Игра окончена! Финальный счет:', this.score);
            }

            handleLevelUp(oldLevel, newLevel) {
                // Level rewards
                const rewards = this.getLevelRewards(newLevel);
                
                // Apply rewards
                rewards.forEach(reward => {
                    if (reward.type === 'coins') {
                        this.addCoins(reward.amount);
                    } else if (reward.type === 'booster') {
                        this.boosters.add(reward.item, reward.amount);
                    } else if (reward.type === 'energy_max_increase') {
                        this.energy.max += reward.amount;
                    }
                });
                
                // Show level up overlay
                document.getElementById('newLevel').textContent = newLevel;
                this.showLevelRewards(rewards);
                this.showOverlay('levelUpOverlay');
                
                // Animate user level
                const userLevel = document.getElementById('userLevelMain');
                userLevel.classList.add('level-up-animation');
                setTimeout(() => {
                    userLevel.classList.remove('level-up-animation');
                }, 1500);
            }

            getLevelRewards(level) {
                const rewards = [
                    { type: 'coins', amount: 50 * level },
                    { type: 'booster', item: 'refresh', amount: 1 }
                ];
                
                // Every 5 levels
                if (level % 5 === 0) {
                    rewards.push({ type: 'booster', item: 'shape_choice', amount: 1 });
                    rewards.push({ type: 'coins', amount: 200 });
                }
                
                // Every 10 levels
                if (level % 10 === 0) {
                    rewards.push({ type: 'booster', item: 'row_blast', amount: 1 });
                    rewards.push({ type: 'energy_max_increase', amount: 1 });
                    rewards.push({ type: 'coins', amount: 500 });
                }
                
                // Every 25 levels
                if (level % 25 === 0) {
                    rewards.push({ type: 'booster', item: 'lightning', amount: 1 });
                    rewards.push({ type: 'booster', item: 'star_blast', amount: 1 });
                    rewards.push({ type: 'energy_max_increase', amount: 2 });
                    rewards.push({ type: 'coins', amount: 1000 });
                }
                
                return rewards;
            }

            showLevelRewards(rewards) {
                const container = document.getElementById('levelRewards');
                container.innerHTML = '';
                
                rewards.forEach((reward, index) => {
                    const badge = document.createElement('div');
                    badge.className = 'achievement';
                    
                    let text = '';
                    if (reward.type === 'coins') {
                        text = `🪙 +${reward.amount} Монет`;
                    } else if (reward.type === 'booster') {
                        const icons = {
                            shape_choice: '🎯',
                            row_blast: '💣',
                            refresh: '🔄',
                            lightning: '⚡',
                            star_blast: '🌟'
                        };
                        text = `${icons[reward.item]} +${reward.amount} ${this.boosters.getName(reward.item)}`;
                    } else if (reward.type === 'energy_max_increase') {
                        text = `⚡ +${reward.amount} Макс Энергия`;
                    }
                    
                    badge.textContent = text;
                    badge.style.animationDelay = (index * 0.1) + 's';
                    container.appendChild(badge);
                });
            }

            showAchievements() {
                const achievements = [];
                
                if (this.score >= 1000) achievements.push('🚀 Ракетный Старт');
                if (this.score >= 5000) achievements.push('⭐ Звездный Игрок');
                if (this.score >= 10000) achievements.push('💎 Алмазный Мастер');
                if (this.score >= 25000) achievements.push('👑 Блочный Император');
                if (this.score >= 50000) achievements.push('🌟 Космическая Легенда');
                if (this.linesCleared >= 20) achievements.push('💥 Разрушитель Линий');
                if (this.linesCleared >= 50) achievements.push('🔥 Мастер Цепочек');
                if (this.combo >= 5) achievements.push('⚡ Король Комбо');
                if (this.combo >= 10) achievements.push('🌪️ Повелитель Бури');
                if (this.level.current >= 10) achievements.push('📈 Мастер Уровней');

                const container = document.getElementById('achievementsList');
                container.innerHTML = '';

                achievements.forEach((achievement, index) => {
                    const badge = document.createElement('div');
                    badge.className = 'achievement';
                    badge.textContent = achievement;
                    badge.style.animationDelay = (index * 0.15) + 's';
                    container.appendChild(badge);
                });
            }

            updateUI() {
                // Score
                document.getElementById('score').textContent = this.score.toLocaleString();
                document.getElementById('bestScore').textContent = this.bestScore.toLocaleString();
                document.getElementById('linesCleared').textContent = this.linesCleared;
                
                // Energy
                this.updateEnergyDisplay();
                
                // Level
                document.getElementById('userLevelMain').textContent = this.level.current;
                document.getElementById('xpFill').style.width = this.level.getProgress() + '%';
                document.getElementById('xpText').textContent = 
                    `${this.level.currentXP} / ${this.level.getXPRequired(this.level.current)} XP`;
                
                // Coins
                document.getElementById('coinsCount').textContent = this.coins.toLocaleString();
                
                // Boosters
                Object.keys(this.boosters.inventory).forEach(type => {
                    const countElement = document.getElementById(`count_${type}`);
                    const boosterElement = document.getElementById(`booster_${type}`);
                    if (countElement) {
                        countElement.textContent = this.boosters.inventory[type];
                        if (this.boosters.inventory[type] === 0) {
                            boosterElement.classList.add('disabled');
                        } else {
                            boosterElement.classList.remove('disabled');
                        }
                    }
                });
                
                // Referrals
                document.getElementById('invitesSent').textContent = this.referrals.invitesSent;
                document.getElementById('friendsJoined').textContent = this.referrals.friendsJoined;
                
                // No energy state
                const gameContainer = document.querySelector('.game-container');
                if (!this.energy.canPlay() && !this.isGameOver) {
                    gameContainer.classList.add('no-energy');
                } else {
                    gameContainer.classList.remove('no-energy');
                }
            }

            updateEnergyDisplay() {
                this.energy.updateEnergy();
                const energyCount = document.getElementById('energyCount');
                const energyTimer = document.getElementById('energyTimer');
                const nextEnergyTime = document.getElementById('nextEnergyTime');
                
                energyCount.textContent = `${this.energy.current}/${this.energy.max}`;
                
                if (this.energy.current < this.energy.max) {
                    const timeToNext = this.energy.getTimeToNext();
                    const minutes = Math.floor(timeToNext / 60000);
                    const seconds = Math.floor((timeToNext % 60000) / 1000);
                    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    energyTimer.textContent = `Через ${timeString}`;
                    if (nextEnergyTime) {
                        nextEnergyTime.textContent = timeString;
                    }
                } else {
                    energyTimer.textContent = 'Полная энергия!';
                    if (nextEnergyTime) {
                        nextEnergyTime.textContent = '--:--';
                    }
                }
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 100);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 400);
                }, 3000);
            }

            showOverlay(overlayId) {
                const overlay = document.getElementById(overlayId);
                overlay.classList.add('active');
            }

            closeOverlay(overlayId) {
                const overlay = document.getElementById(overlayId);
                overlay.classList.remove('active');
            }

            pause() {
                this.isPaused = !this.isPaused;
                const pauseBtn = document.getElementById('pauseBtn');
                const shapesArea = document.getElementById('shapesArea');
                
                if (this.isPaused) {
                    shapesArea.style.opacity = '0.3';
                    shapesArea.style.pointerEvents = 'none';
                    shapesArea.style.filter = 'blur(3px)';
                } else {
                    shapesArea.style.opacity = '1';
                    shapesArea.style.pointerEvents = '';
                    shapesArea.style.filter = '';
                }
            }

            restart() {
                this.grid = [];
                this.score = 0;
                this.linesCleared = 0;
                this.combo = 0;
                this.currentShapes = [];
                this.isGameOver = false;
                this.isPaused = false;
                this.gameStarted = false;

                this.closeOverlay('gameOverOverlay');
                this.closeOverlay('energyDepletedOverlay');
                document.getElementById('comboDisplay').classList.remove('active');

                const shapesArea = document.getElementById('shapesArea');
                shapesArea.style.opacity = '1';
                shapesArea.style.pointerEvents = '';
                shapesArea.style.filter = '';

                document.getElementById('particlesContainer').innerHTML = '';

                this.createGrid();
                this.generateShapes();
                this.updateUI();

                console.log('🔄 Игра перезапущена');
            }
        }

        // Initialize app
        let game;

        async function initializeApp() {
            try {
                // Show loading screen
                document.getElementById('loadingScreen').style.display = 'flex';
                
                // Initialize VK
                await initVK();
                
                // Initialize game
                game = new BlockBlastSocialGame();
                
                // Load VK friends for leaderboard
                if (isVKReady) {
                    await initializePayments(); // Initialize VK Pay
                }
                
                // Start auto-save
                startAutoSave();
                
                // Hide loading screen and show game
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('gameContainer').classList.add('loaded');
                }, 1500);
                
                console.log('🎮 Приложение успешно инициализировано');
                
            } catch (error) {
                console.error('❌ Ошибка инициализации приложения:', error);
                // Show game anyway for development
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('gameContainer').classList.add('loaded');
                game = new BlockBlastSocialGame();
            }
        }

        async function shareScore() {
            const achievements = [];
            if (game.score >= 10000) achievements.push('💎');
            if (game.level.current >= 10) achievements.push('📈');
            if (game.combo >= 5) achievements.push('🔥');
            
            try {
                const success = await shareToVKWall(game.score, game.level.current, achievements);
                
                if (success) {
                    game.showNotification('Результат опубликован! 🚀');
                } else {
                    // Fallback to simple share
                    const text = `🎯 Я набрал ${game.score.toLocaleString()} очков в Блок Взрыв! (Уровень ${game.level.current}) Сможешь побить мой рекорд? 🚀`;
                    
                    if (navigator.share) {
                        await navigator.share({
                            title: 'Блок Взрыв! - Мой Эпический Счет',
                            text: text,
                            url: `https://vk.com/app${APP_CONFIG.APP_ID}`
                        });
                    } else if (navigator.clipboard) {
                        await navigator.clipboard.writeText(text);
                        game.showNotification('Счет скопирован в буфер обмена! 📋');
                    }
                }
                
            } catch (error) {
                console.log('Ошибка публикации:', error);
                game.showNotification('Ошибка публикации результата 😞');
            }
        }

        // Global functions for UI interactions
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.game-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + 'Content').classList.add('active');

            // Update leaderboard if needed
            if (tabName === 'leaderboard') {
                showLeaderboard('global');
            }
        }

        function showLeaderboard(type) {
            // Update leaderboard tabs
            document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            const list = document.getElementById('leaderboardList');
            const data = game.leaderboard[type] || [];
            
            list.innerHTML = '';
            data.forEach(player => {
                const item = document.createElement('div');
                item.className = `leaderboard-item ${player.isMe ? 'me' : ''}`;
                
                let rankClass = '';
                if (player.rank === 1) rankClass = 'gold';
                else if (player.rank === 2) rankClass = 'silver';
                else if (player.rank === 3) rankClass = 'bronze';
                
                const avatarContent = typeof player.avatar === 'string' && player.avatar.startsWith('http') 
                    ? `<img src="${player.avatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" alt="Avatar">`
                    : player.avatar;
                
                item.innerHTML = `
                    <div class="leaderboard-rank ${rankClass}">${player.rank}</div>
                    <div class="leaderboard-avatar">${avatarContent}</div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">${player.name}</div>
                        <div class="leaderboard-level">Уровень ${player.level}</div>
                    </div>
                    <div class="leaderboard-score">${player.score.toLocaleString()}</div>
                `;
                
                list.appendChild(item);
            });
        }

        function useBooster(type) {
            if (!game.boosters.has(type)) {
                game.showNotification(`Нет ${game.boosters.getName(type)}! 🚫`);
                return;
            }

            if (game.boosters.use(type)) {
                game.showNotification(`${game.boosters.getName(type)} активирован! ✨`);
                
                switch (type) {
                    case 'shape_choice':
                        game.showShapeChoiceDialog();
                        break;
                    case 'row_blast':
                        game.activateRowBlastMode();
                        break;
                    case 'refresh':
                        game.generateShapes();
                        break;
                    case 'lightning':
                        game.activateLightningMode();
                        break;
                    case 'star_blast':
                        game.activateStarBlastMode();
                        break;
                }
            }
        }

        function buyPack(packType) {
            const packs = {
                starter: { price: 150, items: { shape_choice: 3, refresh: 2, row_blast: 1 } },
                premium: { price: 450, items: { shape_choice: 5, row_blast: 3, lightning: 2, star_blast: 1 } },
                ultimate: { price: 990, items: { shape_choice: 10, row_blast: 8, lightning: 5, star_blast: 3, refresh: 5 } }
            };
            
            const pack = packs[packType];
            
            if (game.coins >= pack.price) {
                game.coins -= pack.price;
                
                Object.entries(pack.items).forEach(([type, amount]) => {
                    game.boosters.add(type, amount);
                });
                
                game.updateUI();
                game.showNotification(`${packType.toUpperCase()} набор куплен! 🎁`);
                
                // Save purchase
                if (isVKReady) {
                    saveGameData();
                }
            } else {
                game.showNotification(`Недостаточно монет! Нужно ${pack.price} 🪙`);
            }
        }

        function buyEnergy(amount) {
            const prices = { 1: 50, 5: 200 };
            const price = prices[amount];
            
            if (game.coins >= price) {
                game.coins -= price;
                game.energy.add(amount);
                game.updateUI();
                game.showNotification(`+${amount} Энергия куплена! ⚡`);
                
                // Save purchase
                if (isVKReady) {
                    saveGameData();
                }
            } else {
                game.showNotification(`Недостаточно монет! Нужно ${price} 🪙`);
            }
        }

        async function inviteFriends() {
            if (game.referrals.sendInvite()) {
                try {
                    const success = await inviteVKFriends();
                    
                    if (success) {
                        game.showNotification('Приглашение отправлено! 📱');
                        
                        // Simulate friend joining (20% chance)
                        setTimeout(() => {
                            if (Math.random() < 0.2) {
                                game.referrals.friendJoined();
                                game.showNotification(`Друг присоединился к игре! 🎉`);
                            }
                        }, 2000);
                    } else {
                        game.showNotification('Ошибка отправки приглашения 😞');
                    }
                    
                } catch (error) {
                    console.log('Ошибка отправки приглашения:', error);
                    game.showNotification('Ошибка отправки приглашения 😞');
                }
                
                game.updateUI();
                
                // Save data
                if (isVKReady) {
                    saveGameData();
                }
            }
        }

        // VK Payments integration for buying coins with votes
        async function buyCoinsVK(coins, votes) {
            if (!isVKReady) {
                game.showNotification('❌ VK недоступен для платежей');
                return;
            }

            try {
                // Show confirmation dialog
                const confirmPurchase = confirm(
                    `💰 Купить ${coins.toLocaleString()} монет за ${votes} голосов?\n\n` +
                    `Это поможет развитию игры! 💙`
                );

                if (!confirmPurchase) return;

                game.showNotification('💳 Обработка платежа...');

                // Create payment order
                const paymentData = {
                    action: 'pay-to-service',
                    params: {
                        amount: votes,
                        description: `Покупка ${coins} монет в игре "Блок Взрыв!"`,
                        data: {
                            coins: coins,
                            votes: votes,
                            userId: currentUser?.id || 0,
                            timestamp: Date.now()
                        }
                    }
                };

                // Try VK Pay method
                let paymentResult;
                try {
                    paymentResult = await vkBridge.send('VKWebAppOpenPayForm', paymentData);
                } catch (payError) {
                    // Fallback to simpler method
                    console.log('VK Pay недоступен, используем альтернативный метод');
                    paymentResult = await processAlternativePayment(coins, votes);
                }

                if (paymentResult && (paymentResult.success || paymentResult.result)) {
                    // Payment successful
                    await processSuccessfulPayment(coins, votes);
                } else {
                    throw new Error('Платеж отклонен');
                }

            } catch (error) {
                console.error('Ошибка платежа:', error);
                game.showNotification('❌ Ошибка платежа. Попробуйте позже.');
            }
        }

        // Alternative payment processing (for development/testing)
        async function processAlternativePayment(coins, votes) {
            // Simulate payment process
            game.showNotification('🔄 Симуляция платежа (тестовый режим)...');
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // In development mode, always succeed
            if (APP_CONFIG.environment === 'development') {
                return { success: true, test: true };
            }
            
            // For production, try alternative VK methods
            try {
                return await vkBridge.send('VKWebAppShare', {
                    link: `https://vk.com/app${APP_CONFIG.APP_ID}?payment=${votes}_${coins}`
                });
            } catch (error) {
                throw new Error('Альтернативный платеж недоступен');
            }
        }

        // Process successful payment
        async function processSuccessfulPayment(coins, votes) {
            // Add coins to player
            const oldCoins = game.coins;
            game.addCoins(coins);

            // Special bonuses for premium packages
            if (coins >= 2500) {
                // Premium package bonuses
                game.addCoins(500); // Bonus coins
                game.energy.max += 2; // Increase max energy
                game.boosters.add('star_blast', 1); // Exclusive booster
                
                game.showNotification('👑 Премиум бонусы получены!');
            }

            // Visual success effect
            animatePaymentSuccess();

            // Save progress
            if (isVKReady) {
                await saveGameData();
            }

            // Thank you message
            setTimeout(() => {
                game.showNotification('💙 Спасибо за поддержку игры!');
            }, 1000);

            // Offer to share purchase
            setTimeout(() => {
                offerSharePurchase(coins);
            }, 3000);
        }

        // Animate successful payment
        function animatePaymentSuccess() {
            // Animate coins counter
            const coinsElement = document.getElementById('coinsCount');
            coinsElement.classList.add('payment-success');
            setTimeout(() => {
                coinsElement.classList.remove('payment-success');
            }, 1000);

            // Create coin rain effect
            createCoinRainEffect();
        }

        // Create coin rain visual effect
        function createCoinRainEffect() {
            const container = document.body;
            
            for (let i = 0; i < 30; i++) {
                const coin = document.createElement('div');
                coin.style.cssText = `
                    position: fixed;
                    top: -20px;
                    left: ${Math.random() * 100}vw;
                    width: 20px;
                    height: 20px;
                    background: linear-gradient(45deg, #ffd700, #ffed4e);
                    border-radius: 50%;
                    z-index: 9999;
                    pointer-events: none;
                    box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                coin.textContent = '🪙';
                
                container.appendChild(coin);
                
                // Animate falling
                coin.animate([
                    { 
                        transform: 'translateY(-20px) rotate(0deg)',
                        opacity: 1
                    },
                    { 
                        transform: `translateY(${window.innerHeight + 40}px) rotate(720deg)`,
                        opacity: 0
                    }
                ], {
                    duration: 2000 + Math.random() * 1000,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                }).onfinish = () => coin.remove();
            }
        }

        // Offer to share purchase
        async function offerSharePurchase(coins) {
            try {
                const shareMessage = `💰 Купил ${coins.toLocaleString()} монет в игре "Блок Взрыв!"! Теперь можно покупать крутые усилители! 🚀`;
                
                const result = await vkBridge.send('VKWebAppShowWallPostBox', {
                    message: shareMessage,
                    attachments: `https://vk.com/app${APP_CONFIG.APP_ID}`
                });
                
                if (result.post_id) {
                    // Reward for sharing
                    game.addCoins(25);
                    game.showNotification('🎉 +25 монет за публикацию!');
                }
            } catch (error) {
                // User cancelled sharing - that's okay
                console.log('Пользователь не захотел делиться покупкой');
            }
        }

        // Check VK Pay availability
        async function checkVKPayAvailability() {
            if (!isVKReady) return false;
            
            try {
                // Try to check if payments are supported
                const result = await vkBridge.send('VKWebAppGetConfig');
                return result.app && result.app.payments_enabled;
            } catch (error) {
                console.log('VK Pay недоступен:', error);
                return false;
            }
        }

        // Check VK Pay availability and initialize
        async function initializePayments() {
            if (isVKReady) {
                const payAvailable = await checkVKPayAvailability();
                console.log('💳 VK Pay готов к использованию:', payAvailable);
            }
        }

        function closeOverlay(overlayId) {
            game.closeOverlay(overlayId);
        }

        // Additional booster activation methods
        BlockBlastSocialGame.prototype.showShapeChoiceDialog = function() {
            // Generate 6 random shapes for choice
            const choices = [];
            for (let i = 0; i < 6; i++) {
                const template = this.shapeTemplates[Math.floor(Math.random() * this.shapeTemplates.length)];
                choices.push(template);
            }
            
            // Replace current shapes with first 3 choices
            this.currentShapes = [];
            for (let i = 0; i < 3; i++) {
                const color = this.colors[Math.floor(Math.random() * this.colors.length)];
                this.currentShapes.push({
                    id: i,
                    pattern: choices[i].pattern,
                    name: choices[i].name,
                    color: color,
                    used: false
                });
            }
            this.renderShapes();
        };

        BlockBlastSocialGame.prototype.activateRowBlastMode = function() {
            this.showNotification('Нажмите на любой ряд или столбец для взрыва! 💣');
            // In full implementation, would add click handlers for grid
        };

        BlockBlastSocialGame.prototype.activateLightningMode = function() {
            this.showNotification('Нажмите на 5 блоков чтобы их уничтожить! ⚡');
            // In full implementation, would add click handlers for individual cells
        };

        BlockBlastSocialGame.prototype.activateStarBlastMode = function() {
            this.showNotification('Нажмите чтобы взорвать область 3×3! 🌟');
            // In full implementation, would add handler for 3x3 area
        };

        // Handle orientation change
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                if (game) game.updateUI();
            }, 300);
        });

        // Handle page visibility for energy timer
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && game) {
                game.energy.updateEnergy();
                game.updateUI();
            }
        });

        // Handle app events from VK
        if (window.vkBridge) {
            window.vkBridge.subscribe((e) => {
                if (e.detail.type === 'VKWebAppUpdateConfig') {
                    console.log('VK config updated:', e.detail.data);
                }
            });
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);

        console.log('🎮 Блок Взрыв! VK Mini App v1.0.0 - Готов к запуску! 🚀');
    </script>
</body>
</html>
                